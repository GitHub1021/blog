<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="以梦为马，明日天涯">
<meta property="og:type" content="website">
<meta property="og:title" content="冯玮的博客">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="冯玮的博客">
<meta property="og:description" content="以梦为马，明日天涯">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="冯玮">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>冯玮的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">冯玮的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">码农</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-主页">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>主页</a>

  </li>
        <li class="menu-item menu-item-主题">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>主题</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/01/Spring-Security-%E4%BA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="冯玮">
      <meta itemprop="description" content="以梦为马，明日天涯">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冯玮的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/01/Spring-Security-%E4%BA%8C/" class="post-title-link" itemprop="url">Spring Security(二)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-12-01 17:17:32 / 修改时间：17:17:56" itemprop="dateCreated datePublished" datetime="2020-12-01T17:17:32+08:00">2020-12-01</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h3><p>所谓的授权,就是如果用户要访问某一个资源,我们要去检查用户是否具备这样的权限,如果具备就允许访问,如果不具备,就不能访问</p>
<h3 id="准备测试用户"><a href="#准备测试用户" class="headerlink" title="准备测试用户"></a>准备测试用户</h3><p>基于内存来配置,添加用户的两种方式:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加用户</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       auth.inMemoryAuthentication()</span><br><span class="line">               .withUser(<span class="string">&quot;user01&quot;</span>)</span><br><span class="line">               .password(<span class="string">&quot;123&quot;</span>).roles(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">               .and().withUser(<span class="string">&quot;user02&quot;</span>)</span><br><span class="line">               .password(<span class="string">&quot;1234&quot;</span>).roles(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="meta">@Bean</span></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> UserDetailsService <span class="title">userDetailsService</span><span class="params">()</span></span>&#123;</span><br><span class="line">     InMemoryUserDetailsManager manager = <span class="keyword">new</span> InMemoryUserDetailsManager();</span><br><span class="line">     manager.createUser(User.withUsername(<span class="string">&quot;user03&quot;</span>).password(<span class="string">&quot;123&quot;</span>).roles(<span class="string">&quot;admin&quot;</span>).build());</span><br><span class="line">     manager.createUser(User.withUsername(<span class="string">&quot;user04&quot;</span>).password(<span class="string">&quot;123&quot;</span>).roles(<span class="string">&quot;user&quot;</span>).build());</span><br><span class="line">     <span class="keyword">return</span> manager;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>由于Spring Security 支持多种数据源,例如,内存,数据库,LDAP等,这些不同来源的数据被共同封装成一个UserDetail Service 接口,任何实现了该接口的对象都可以作为认证数据源</p>
<p>因此我们还可以通过重写WebSecurityConfigurerAdapter 中的userDetailsService 方法来提供一个UserDetailsService 实例进而配置多个用户.</p>
<h3 id="准备测试接口"><a href="#准备测试接口" class="headerlink" title="准备测试接口"></a>准备测试接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/admin/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">admin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;user&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这三个测试接口:</p>
<ul>
<li><p>/hello 是任何人都可以访问的接口</p>
</li>
<li><p>/admin/hello 是有admin身份的人才能访问的接口</p>
</li>
<li><p>/user/hello 是具有user身份的人才能访问的 接口</p>
</li>
<li><p>所有user都能够访问的资源,admin都能访问</p>
<p>也就是说凡是具有admin身份的人,都自动具备user身份</p>
</li>
</ul>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>接下来我们来配置权限的拦截规则,在SpringSecurityd的configure(HttpSecurity http) 方法中,代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/admin/**&quot;</span>).hasRole(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/**&quot;</span>).hasRole(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">                .defaultSuccessUrl(<span class="string">&quot;/admin/hello&quot;</span>)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里的匹配规则我们采用了<code>Ant</code>风格的路径匹配符,<code>Ant</code>风格的路径匹配符在Spring家族中使用非常广泛,他的匹配规则也非常简单:</p>
<table>
<thead>
<tr>
<th>通配符</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>**</td>
<td>匹配多层路径</td>
</tr>
<tr>
<td>*</td>
<td>匹配一层路径</td>
</tr>
<tr>
<td>?</td>
<td>匹配任意单个字符</td>
</tr>
</tbody></table>
<p>上面配置的含义是:</p>
<ol>
<li>如果满足请求路径满足<code>/admin/hello/**</code>格式.则用户需要具备 admin 角色</li>
<li>如果请求路径满足<code>/user/hello</code> 格式,则用户需要具备user 角色</li>
<li>剩余的其他格式的请求路径,只需要认证(登录)后就可以访问</li>
</ol>
<p>注意代码 中的配置三条规则的顺序十分重要,和Shiro 类似,SpringSecurity在匹配的时候也是按照从上往下的顺序来匹配,一旦匹配到了就不继续匹配了,<strong>所以拦截规则的顺序不能写错</strong></p>
<p>另一方面,如果你强制 将<code>anyRequest</code>配置在antMatchers前面,向下面这样:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/admin/**&quot;</span>).hasRole(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/**&quot;</span>).hasRole(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/doLogin&quot;</span>)</span><br><span class="line">                .successHandler((req, resp, authentication) -&gt; &#123;</span><br><span class="line">                    Object principal = authentication.getPrincipal();</span><br><span class="line">                    resp.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">                    PrintWriter out = resp.getWriter();</span><br><span class="line">                    out.write(<span class="keyword">new</span> ObjectMapper().writeValueAsString(principal));</span><br><span class="line">                    out.flush();</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125;)</span><br><span class="line">                .failureHandler((req, resp, e) -&gt; &#123;</span><br><span class="line">                    resp.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">                    PrintWriter out = resp.getWriter();</span><br><span class="line">                    out.write(e.getMessage());</span><br><span class="line">                    out.flush();</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125;)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">                .logout()</span><br><span class="line">                .logoutUrl(<span class="string">&quot;/logout&quot;</span>)</span><br><span class="line">                .logoutSuccessHandler((req, resp, authentication) -&gt; &#123;</span><br><span class="line">                    resp.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">                    PrintWriter out = resp.getWriter();</span><br><span class="line">                    out.write(<span class="string">&quot;注销成功&quot;</span>);</span><br><span class="line">                    out.flush();</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125;)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable().exceptionHandling()</span><br><span class="line">                .authenticationEntryPoint((req, resp, authException) -&gt; &#123;</span><br><span class="line">                            resp.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">                            PrintWriter out = resp.getWriter();</span><br><span class="line">                            out.write(<span class="string">&quot;尚未登录，请先登录&quot;</span>);</span><br><span class="line">                            out.flush();</span><br><span class="line">                            out.close();</span><br><span class="line">                        &#125;</span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>此时项目在启动的时候,就会报错,会提示不能再anyRequest 之后添加antMatchers</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.IllegalStateException: Can&#39;t configure antMatchers after anyRequest</span><br><span class="line">g.SecurityConfig$$EnhancerBySpringCGLIB$$7db94ecf.init</span><br></pre></td></tr></table></figure>

<p>从以上语音很好理解,anyRequest 已经包含了其他请求了,在它之后如果还配置其他请求也没有任何意义</p>
<p> 从语义上理解,anyRequest 应该放在最后,表示出了前面拦截规则之外,剩下的请求要如何处理</p>
<p>在拦截规则的配置类  AbstractRequestMatcherRegistry  中,我们可以看到如下乙烯二代码(部分源码):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> C <span class="title">antMatchers</span><span class="params">(HttpMethod method, String... antPatterns)</span> </span>&#123;</span><br><span class="line">		Assert.state(!<span class="keyword">this</span>.anyRequestConfigured, <span class="string">&quot;Can&#x27;t configure antMatchers after anyRequest&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> chainRequestMatchers(RequestMatchers.antMatchers(method, antPatterns));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Maps a &#123;<span class="doctag">@link</span> List&#125; of</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> org.springframework.security.web.util.matcher.AntPathRequestMatcher&#125;</span></span><br><span class="line"><span class="comment">	 * instances that do not care which &#123;<span class="doctag">@link</span> HttpMethod&#125; is used.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> antPatterns the ant patterns to create</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> org.springframework.security.web.util.matcher.AntPathRequestMatcher&#125; from</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the object that is chained after creating the &#123;<span class="doctag">@link</span> RequestMatcher&#125;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> C <span class="title">antMatchers</span><span class="params">(String... antPatterns)</span> </span>&#123;</span><br><span class="line">		Assert.state(!<span class="keyword">this</span>.anyRequestConfigured, <span class="string">&quot;Can&#x27;t configure antMatchers after anyRequest&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> chainRequestMatchers(RequestMatchers.antMatchers(antPatterns));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;</span></span><br><span class="line"><span class="comment">	 * Maps an &#123;<span class="doctag">@link</span> MvcRequestMatcher&#125; that does not care which &#123;<span class="doctag">@link</span> HttpMethod&#125; is</span></span><br><span class="line"><span class="comment">	 * used. This matcher will use the same rules that Spring MVC uses for matching. For</span></span><br><span class="line"><span class="comment">	 * example, often times a mapping of the path &quot;/path&quot; will match on &quot;/path&quot;, &quot;/path/&quot;,</span></span><br><span class="line"><span class="comment">	 * &quot;/path.html&quot;, etc.</span></span><br><span class="line"><span class="comment">	 * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;</span></span><br><span class="line"><span class="comment">	 * If the current request will not be processed by Spring MVC, a reasonable default</span></span><br><span class="line"><span class="comment">	 * using the pattern as a ant pattern will be used.</span></span><br><span class="line"><span class="comment">	 * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mvcPatterns the patterns to match on. The rules for matching are defined by</span></span><br><span class="line"><span class="comment">	 * Spring MVC</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the object that is chained after creating the &#123;<span class="doctag">@link</span> RequestMatcher&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> C <span class="title">mvcMatchers</span><span class="params">(String... mvcPatterns)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;</span></span><br><span class="line"><span class="comment">	 * Maps an &#123;<span class="doctag">@link</span> MvcRequestMatcher&#125; that also specifies a specific &#123;<span class="doctag">@link</span> HttpMethod&#125;</span></span><br><span class="line"><span class="comment">	 * to match on. This matcher will use the same rules that Spring MVC uses for</span></span><br><span class="line"><span class="comment">	 * matching. For example, often times a mapping of the path &quot;/path&quot; will match on</span></span><br><span class="line"><span class="comment">	 * &quot;/path&quot;, &quot;/path/&quot;, &quot;/path.html&quot;, etc.</span></span><br><span class="line"><span class="comment">	 * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;</span></span><br><span class="line"><span class="comment">	 * If the current request will not be processed by Spring MVC, a reasonable default</span></span><br><span class="line"><span class="comment">	 * using the pattern as a ant pattern will be used.</span></span><br><span class="line"><span class="comment">	 * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> method the HTTP method to match on</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mvcPatterns the patterns to match on. The rules for matching are defined by</span></span><br><span class="line"><span class="comment">	 * Spring MVC</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the object that is chained after creating the &#123;<span class="doctag">@link</span> RequestMatcher&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> C <span class="title">mvcMatchers</span><span class="params">(HttpMethod method, String... mvcPatterns)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Creates &#123;<span class="doctag">@link</span> MvcRequestMatcher&#125; instances for the method and patterns passed in</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> method the HTTP method to use or null if any should be used</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mvcPatterns the Spring MVC patterns to match on</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a List of &#123;<span class="doctag">@link</span> MvcRequestMatcher&#125; instances</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> List&lt;MvcRequestMatcher&gt; <span class="title">createMvcMatchers</span><span class="params">(HttpMethod method, String... mvcPatterns)</span> </span>&#123;</span><br><span class="line">		Assert.state(!<span class="keyword">this</span>.anyRequestConfigured, <span class="string">&quot;Can&#x27;t configure mvcMatchers after anyRequest&quot;</span>);</span><br><span class="line">		ObjectPostProcessor&lt;Object&gt; opp = <span class="keyword">this</span>.context.getBean(ObjectPostProcessor.class);</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">this</span>.context.containsBean(HANDLER_MAPPING_INTROSPECTOR_BEAN_NAME)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> NoSuchBeanDefinitionException(<span class="string">&quot;A Bean named &quot;</span> + HANDLER_MAPPING_INTROSPECTOR_BEAN_NAME</span><br><span class="line">					+ <span class="string">&quot; of type &quot;</span> + HandlerMappingIntrospector.class.getName()</span><br><span class="line">					+ <span class="string">&quot; is required to use MvcRequestMatcher. Please ensure Spring Security &amp; Spring MVC are configured in a shared ApplicationContext.&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		HandlerMappingIntrospector introspector = <span class="keyword">this</span>.context.getBean(HANDLER_MAPPING_INTROSPECTOR_BEAN_NAME,</span><br><span class="line">				HandlerMappingIntrospector.class);</span><br><span class="line">		List&lt;MvcRequestMatcher&gt; matchers = <span class="keyword">new</span> ArrayList&lt;&gt;(mvcPatterns.length);</span><br><span class="line">		<span class="keyword">for</span> (String mvcPattern : mvcPatterns) &#123;</span><br><span class="line">			MvcRequestMatcher matcher = <span class="keyword">new</span> MvcRequestMatcher(introspector, mvcPattern);</span><br><span class="line">			opp.postProcess(matcher);</span><br><span class="line">			<span class="keyword">if</span> (method != <span class="keyword">null</span>) &#123;</span><br><span class="line">				matcher.setMethod(method);</span><br><span class="line">			&#125;</span><br><span class="line">			matchers.add(matcher);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> matchers;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Maps a &#123;<span class="doctag">@link</span> List&#125; of</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> org.springframework.security.web.util.matcher.RegexRequestMatcher&#125;</span></span><br><span class="line"><span class="comment">	 * instances.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> method the &#123;<span class="doctag">@link</span> HttpMethod&#125; to use or &#123;<span class="doctag">@code</span> null&#125; for any</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> HttpMethod&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> regexPatterns the regular expressions to create</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> org.springframework.security.web.util.matcher.RegexRequestMatcher&#125; from</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the object that is chained after creating the &#123;<span class="doctag">@link</span> RequestMatcher&#125;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> C <span class="title">regexMatchers</span><span class="params">(HttpMethod method, String... regexPatterns)</span> </span>&#123;</span><br><span class="line">		Assert.state(!<span class="keyword">this</span>.anyRequestConfigured, <span class="string">&quot;Can&#x27;t configure regexMatchers after anyRequest&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> chainRequestMatchers(RequestMatchers.regexMatchers(method, regexPatterns));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a &#123;<span class="doctag">@link</span> List&#125; of</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> org.springframework.security.web.util.matcher.RegexRequestMatcher&#125; instances</span></span><br><span class="line"><span class="comment">	 * that do not specify an &#123;<span class="doctag">@link</span> HttpMethod&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> regexPatterns the regular expressions to create</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> org.springframework.security.web.util.matcher.RegexRequestMatcher&#125; from</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the object that is chained after creating the &#123;<span class="doctag">@link</span> RequestMatcher&#125;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> C <span class="title">regexMatchers</span><span class="params">(String... regexPatterns)</span> </span>&#123;</span><br><span class="line">		Assert.state(!<span class="keyword">this</span>.anyRequestConfigured, <span class="string">&quot;Can&#x27;t configure regexMatchers after anyRequest&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> chainRequestMatchers(RequestMatchers.regexMatchers(regexPatterns));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Associates a list of &#123;<span class="doctag">@link</span> RequestMatcher&#125; instances with the</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> AbstractConfigAttributeRequestMatcherRegistry&#125;</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> requestMatchers the &#123;<span class="doctag">@link</span> RequestMatcher&#125; instances</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the object that is chained after creating the &#123;<span class="doctag">@link</span> RequestMatcher&#125;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> C <span class="title">requestMatchers</span><span class="params">(RequestMatcher... requestMatchers)</span> </span>&#123;</span><br><span class="line">		Assert.state(!<span class="keyword">this</span>.anyRequestConfigured, <span class="string">&quot;Can&#x27;t configure requestMatchers after anyRequest&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> chainRequestMatchers(Arrays.asList(requestMatchers));</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>从以上源码可以看出来,做 任何规则配置之前,都要先判断anyRequest 是否已经配置,如果一已经配置,则会抛出异常</p>
<h3 id="启动测试"><a href="#启动测试" class="headerlink" title="启动测试"></a>启动测试</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST http://localhost:8080/doLogin?username=user03&amp;password=123</span><br><span class="line"><span class="attribute">Accept</span>: */*</span><br><span class="line"><span class="attribute">Cache-Control</span>: no-cache</span><br></pre></td></tr></table></figure>

<p>返回结果:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;password&quot;</span>:<span class="literal">null</span>,<span class="attr">&quot;username&quot;</span>:<span class="string">&quot;user03&quot;</span>,<span class="attr">&quot;authorities&quot;</span>:[&#123;<span class="attr">&quot;authority&quot;</span>:<span class="string">&quot;ROLE_admin&quot;</span>&#125;],<span class="attr">&quot;accountNonExpired&quot;</span>:<span class="literal">true</span>,<span class="attr">&quot;accountNonLocked&quot;</span>:<span class="literal">true</span>,<span class="attr">&quot;credentialsNonExpired&quot;</span>:<span class="literal">true</span>,<span class="attr">&quot;enabled&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<p>登录成功后，分别访问 <code>/hello</code>，<code>/admin/hello</code> 以及 <code>/user/hello</code> 三个接口，其中：</p>
<ol>
<li><code>/hello</code> 因为登录后就可以访问，这个接口访问成功。</li>
<li><code>/admin/hello</code> 需要 admin 身份，所以访问失败。</li>
<li><code>/user/hello</code> 需要 user 身份，所以访问成功。</li>
</ol>
<h3 id="角色继承"><a href="#角色继承" class="headerlink" title="角色继承"></a>角色继承</h3><p>第四条规则是user能够访问的资源,admin都能够访问</p>
<p>现在要去实现user能够访问的资源,admin都能够访问,这涉及到另外一个知识点,叫做角色的继承</p>
<p>这个在实际开发中非常的有用</p>
<p>上级可能具备下级的所有权限.如果使用角色继承,这个功能就很好实现,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">   <span class="function">RoleHierarchy <span class="title">roleHierarchy</span><span class="params">()</span></span>&#123;</span><br><span class="line">       RoleHierarchyImpl roleHierarchy = <span class="keyword">new</span> RoleHierarchyImpl();</span><br><span class="line">       roleHierarchy.setHierarchy(<span class="string">&quot;ROLE_admin &gt; ROLE_user&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span> roleHierarchy;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意，在配置时，需要给角色手动加上 <code>ROLE_</code> 前缀。上面的配置表示 <code>ROLE_admin</code> 自动具备 <code>ROLE_user</code> 的权限</strong></p>
<p>重启项目之后,user03登陆之后也能访问<code>/user/hello</code></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/01/Spring-Security%E7%9A%84%E6%8E%88%E6%9D%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="冯玮">
      <meta itemprop="description" content="以梦为马，明日天涯">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冯玮的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/01/Spring-Security%E7%9A%84%E6%8E%88%E6%9D%83/" class="post-title-link" itemprop="url">Spring Security的授权</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-12-01 17:14:43 / 修改时间：17:17:49" itemprop="dateCreated datePublished" datetime="2020-12-01T17:14:43+08:00">2020-12-01</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h3><p>所谓的授权,就是如果用户要访问某一个资源,我们要去检查用户是否具备这样的权限,如果具备就允许访问,如果不具备,就不能访问</p>
<h3 id="准备测试用户"><a href="#准备测试用户" class="headerlink" title="准备测试用户"></a>准备测试用户</h3><p>基于内存来配置,添加用户的两种方式:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加用户</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       auth.inMemoryAuthentication()</span><br><span class="line">               .withUser(<span class="string">&quot;user01&quot;</span>)</span><br><span class="line">               .password(<span class="string">&quot;123&quot;</span>).roles(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">               .and().withUser(<span class="string">&quot;user02&quot;</span>)</span><br><span class="line">               .password(<span class="string">&quot;1234&quot;</span>).roles(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="meta">@Bean</span></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> UserDetailsService <span class="title">userDetailsService</span><span class="params">()</span></span>&#123;</span><br><span class="line">     InMemoryUserDetailsManager manager = <span class="keyword">new</span> InMemoryUserDetailsManager();</span><br><span class="line">     manager.createUser(User.withUsername(<span class="string">&quot;user03&quot;</span>).password(<span class="string">&quot;123&quot;</span>).roles(<span class="string">&quot;admin&quot;</span>).build());</span><br><span class="line">     manager.createUser(User.withUsername(<span class="string">&quot;user04&quot;</span>).password(<span class="string">&quot;123&quot;</span>).roles(<span class="string">&quot;user&quot;</span>).build());</span><br><span class="line">     <span class="keyword">return</span> manager;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>由于Spring Security 支持多种数据源,例如,内存,数据库,LDAP等,这些不同来源的数据被共同封装成一个UserDetail Service 接口,任何实现了该接口的对象都可以作为认证数据源</p>
<p>因此我们还可以通过重写WebSecurityConfigurerAdapter 中的userDetailsService 方法来提供一个UserDetailsService 实例进而配置多个用户.</p>
<h3 id="准备测试接口"><a href="#准备测试接口" class="headerlink" title="准备测试接口"></a>准备测试接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/admin/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">admin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;user&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这三个测试接口:</p>
<ul>
<li><p>/hello 是任何人都可以访问的接口</p>
</li>
<li><p>/admin/hello 是有admin身份的人才能访问的接口</p>
</li>
<li><p>/user/hello 是具有user身份的人才能访问的 接口</p>
</li>
<li><p>所有user都能够访问的资源,admin都能访问</p>
<p>也就是说凡是具有admin身份的人,都自动具备user身份</p>
</li>
</ul>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>接下来我们来配置权限的拦截规则,在SpringSecurityd的configure(HttpSecurity http) 方法中,代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/admin/**&quot;</span>).hasRole(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/**&quot;</span>).hasRole(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">                .defaultSuccessUrl(<span class="string">&quot;/admin/hello&quot;</span>)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里的匹配规则我们采用了<code>Ant</code>风格的路径匹配符,<code>Ant</code>风格的路径匹配符在Spring家族中使用非常广泛,他的匹配规则也非常简单:</p>
<table>
<thead>
<tr>
<th>通配符</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>**</td>
<td>匹配多层路径</td>
</tr>
<tr>
<td>*</td>
<td>匹配一层路径</td>
</tr>
<tr>
<td>?</td>
<td>匹配任意单个字符</td>
</tr>
</tbody></table>
<p>上面配置的含义是:</p>
<ol>
<li>如果满足请求路径满足<code>/admin/hello/**</code>格式.则用户需要具备 admin 角色</li>
<li>如果请求路径满足<code>/user/hello</code> 格式,则用户需要具备user 角色</li>
<li>剩余的其他格式的请求路径,只需要认证(登录)后就可以访问</li>
</ol>
<p>注意代码 中的配置三条规则的顺序十分重要,和Shiro 类似,SpringSecurity在匹配的时候也是按照从上往下的顺序来匹配,一旦匹配到了就不继续匹配了,<strong>所以拦截规则的顺序不能写错</strong></p>
<p>另一方面,如果你强制 将<code>anyRequest</code>配置在antMatchers前面,向下面这样:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/admin/**&quot;</span>).hasRole(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/**&quot;</span>).hasRole(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/doLogin&quot;</span>)</span><br><span class="line">                .successHandler((req, resp, authentication) -&gt; &#123;</span><br><span class="line">                    Object principal = authentication.getPrincipal();</span><br><span class="line">                    resp.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">                    PrintWriter out = resp.getWriter();</span><br><span class="line">                    out.write(<span class="keyword">new</span> ObjectMapper().writeValueAsString(principal));</span><br><span class="line">                    out.flush();</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125;)</span><br><span class="line">                .failureHandler((req, resp, e) -&gt; &#123;</span><br><span class="line">                    resp.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">                    PrintWriter out = resp.getWriter();</span><br><span class="line">                    out.write(e.getMessage());</span><br><span class="line">                    out.flush();</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125;)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">                .logout()</span><br><span class="line">                .logoutUrl(<span class="string">&quot;/logout&quot;</span>)</span><br><span class="line">                .logoutSuccessHandler((req, resp, authentication) -&gt; &#123;</span><br><span class="line">                    resp.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">                    PrintWriter out = resp.getWriter();</span><br><span class="line">                    out.write(<span class="string">&quot;注销成功&quot;</span>);</span><br><span class="line">                    out.flush();</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125;)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable().exceptionHandling()</span><br><span class="line">                .authenticationEntryPoint((req, resp, authException) -&gt; &#123;</span><br><span class="line">                            resp.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">                            PrintWriter out = resp.getWriter();</span><br><span class="line">                            out.write(<span class="string">&quot;尚未登录，请先登录&quot;</span>);</span><br><span class="line">                            out.flush();</span><br><span class="line">                            out.close();</span><br><span class="line">                        &#125;</span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>此时项目在启动的时候,就会报错,会提示不能再anyRequest 之后添加antMatchers</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.IllegalStateException: Can&#39;t configure antMatchers after anyRequest</span><br><span class="line">g.SecurityConfig$$EnhancerBySpringCGLIB$$7db94ecf.init</span><br></pre></td></tr></table></figure>

<p>从以上语音很好理解,anyRequest 已经包含了其他请求了,在它之后如果还配置其他请求也没有任何意义</p>
<p> 从语义上理解,anyRequest 应该放在最后,表示出了前面拦截规则之外,剩下的请求要如何处理</p>
<p>在拦截规则的配置类  AbstractRequestMatcherRegistry  中,我们可以看到如下乙烯二代码(部分源码):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> C <span class="title">antMatchers</span><span class="params">(HttpMethod method, String... antPatterns)</span> </span>&#123;</span><br><span class="line">		Assert.state(!<span class="keyword">this</span>.anyRequestConfigured, <span class="string">&quot;Can&#x27;t configure antMatchers after anyRequest&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> chainRequestMatchers(RequestMatchers.antMatchers(method, antPatterns));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Maps a &#123;<span class="doctag">@link</span> List&#125; of</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> org.springframework.security.web.util.matcher.AntPathRequestMatcher&#125;</span></span><br><span class="line"><span class="comment">	 * instances that do not care which &#123;<span class="doctag">@link</span> HttpMethod&#125; is used.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> antPatterns the ant patterns to create</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> org.springframework.security.web.util.matcher.AntPathRequestMatcher&#125; from</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the object that is chained after creating the &#123;<span class="doctag">@link</span> RequestMatcher&#125;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> C <span class="title">antMatchers</span><span class="params">(String... antPatterns)</span> </span>&#123;</span><br><span class="line">		Assert.state(!<span class="keyword">this</span>.anyRequestConfigured, <span class="string">&quot;Can&#x27;t configure antMatchers after anyRequest&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> chainRequestMatchers(RequestMatchers.antMatchers(antPatterns));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;</span></span><br><span class="line"><span class="comment">	 * Maps an &#123;<span class="doctag">@link</span> MvcRequestMatcher&#125; that does not care which &#123;<span class="doctag">@link</span> HttpMethod&#125; is</span></span><br><span class="line"><span class="comment">	 * used. This matcher will use the same rules that Spring MVC uses for matching. For</span></span><br><span class="line"><span class="comment">	 * example, often times a mapping of the path &quot;/path&quot; will match on &quot;/path&quot;, &quot;/path/&quot;,</span></span><br><span class="line"><span class="comment">	 * &quot;/path.html&quot;, etc.</span></span><br><span class="line"><span class="comment">	 * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;</span></span><br><span class="line"><span class="comment">	 * If the current request will not be processed by Spring MVC, a reasonable default</span></span><br><span class="line"><span class="comment">	 * using the pattern as a ant pattern will be used.</span></span><br><span class="line"><span class="comment">	 * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mvcPatterns the patterns to match on. The rules for matching are defined by</span></span><br><span class="line"><span class="comment">	 * Spring MVC</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the object that is chained after creating the &#123;<span class="doctag">@link</span> RequestMatcher&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> C <span class="title">mvcMatchers</span><span class="params">(String... mvcPatterns)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;</span></span><br><span class="line"><span class="comment">	 * Maps an &#123;<span class="doctag">@link</span> MvcRequestMatcher&#125; that also specifies a specific &#123;<span class="doctag">@link</span> HttpMethod&#125;</span></span><br><span class="line"><span class="comment">	 * to match on. This matcher will use the same rules that Spring MVC uses for</span></span><br><span class="line"><span class="comment">	 * matching. For example, often times a mapping of the path &quot;/path&quot; will match on</span></span><br><span class="line"><span class="comment">	 * &quot;/path&quot;, &quot;/path/&quot;, &quot;/path.html&quot;, etc.</span></span><br><span class="line"><span class="comment">	 * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;</span></span><br><span class="line"><span class="comment">	 * If the current request will not be processed by Spring MVC, a reasonable default</span></span><br><span class="line"><span class="comment">	 * using the pattern as a ant pattern will be used.</span></span><br><span class="line"><span class="comment">	 * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> method the HTTP method to match on</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mvcPatterns the patterns to match on. The rules for matching are defined by</span></span><br><span class="line"><span class="comment">	 * Spring MVC</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the object that is chained after creating the &#123;<span class="doctag">@link</span> RequestMatcher&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> C <span class="title">mvcMatchers</span><span class="params">(HttpMethod method, String... mvcPatterns)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Creates &#123;<span class="doctag">@link</span> MvcRequestMatcher&#125; instances for the method and patterns passed in</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> method the HTTP method to use or null if any should be used</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mvcPatterns the Spring MVC patterns to match on</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a List of &#123;<span class="doctag">@link</span> MvcRequestMatcher&#125; instances</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> List&lt;MvcRequestMatcher&gt; <span class="title">createMvcMatchers</span><span class="params">(HttpMethod method, String... mvcPatterns)</span> </span>&#123;</span><br><span class="line">		Assert.state(!<span class="keyword">this</span>.anyRequestConfigured, <span class="string">&quot;Can&#x27;t configure mvcMatchers after anyRequest&quot;</span>);</span><br><span class="line">		ObjectPostProcessor&lt;Object&gt; opp = <span class="keyword">this</span>.context.getBean(ObjectPostProcessor.class);</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">this</span>.context.containsBean(HANDLER_MAPPING_INTROSPECTOR_BEAN_NAME)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> NoSuchBeanDefinitionException(<span class="string">&quot;A Bean named &quot;</span> + HANDLER_MAPPING_INTROSPECTOR_BEAN_NAME</span><br><span class="line">					+ <span class="string">&quot; of type &quot;</span> + HandlerMappingIntrospector.class.getName()</span><br><span class="line">					+ <span class="string">&quot; is required to use MvcRequestMatcher. Please ensure Spring Security &amp; Spring MVC are configured in a shared ApplicationContext.&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		HandlerMappingIntrospector introspector = <span class="keyword">this</span>.context.getBean(HANDLER_MAPPING_INTROSPECTOR_BEAN_NAME,</span><br><span class="line">				HandlerMappingIntrospector.class);</span><br><span class="line">		List&lt;MvcRequestMatcher&gt; matchers = <span class="keyword">new</span> ArrayList&lt;&gt;(mvcPatterns.length);</span><br><span class="line">		<span class="keyword">for</span> (String mvcPattern : mvcPatterns) &#123;</span><br><span class="line">			MvcRequestMatcher matcher = <span class="keyword">new</span> MvcRequestMatcher(introspector, mvcPattern);</span><br><span class="line">			opp.postProcess(matcher);</span><br><span class="line">			<span class="keyword">if</span> (method != <span class="keyword">null</span>) &#123;</span><br><span class="line">				matcher.setMethod(method);</span><br><span class="line">			&#125;</span><br><span class="line">			matchers.add(matcher);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> matchers;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Maps a &#123;<span class="doctag">@link</span> List&#125; of</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> org.springframework.security.web.util.matcher.RegexRequestMatcher&#125;</span></span><br><span class="line"><span class="comment">	 * instances.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> method the &#123;<span class="doctag">@link</span> HttpMethod&#125; to use or &#123;<span class="doctag">@code</span> null&#125; for any</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> HttpMethod&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> regexPatterns the regular expressions to create</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> org.springframework.security.web.util.matcher.RegexRequestMatcher&#125; from</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the object that is chained after creating the &#123;<span class="doctag">@link</span> RequestMatcher&#125;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> C <span class="title">regexMatchers</span><span class="params">(HttpMethod method, String... regexPatterns)</span> </span>&#123;</span><br><span class="line">		Assert.state(!<span class="keyword">this</span>.anyRequestConfigured, <span class="string">&quot;Can&#x27;t configure regexMatchers after anyRequest&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> chainRequestMatchers(RequestMatchers.regexMatchers(method, regexPatterns));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a &#123;<span class="doctag">@link</span> List&#125; of</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> org.springframework.security.web.util.matcher.RegexRequestMatcher&#125; instances</span></span><br><span class="line"><span class="comment">	 * that do not specify an &#123;<span class="doctag">@link</span> HttpMethod&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> regexPatterns the regular expressions to create</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> org.springframework.security.web.util.matcher.RegexRequestMatcher&#125; from</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the object that is chained after creating the &#123;<span class="doctag">@link</span> RequestMatcher&#125;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> C <span class="title">regexMatchers</span><span class="params">(String... regexPatterns)</span> </span>&#123;</span><br><span class="line">		Assert.state(!<span class="keyword">this</span>.anyRequestConfigured, <span class="string">&quot;Can&#x27;t configure regexMatchers after anyRequest&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> chainRequestMatchers(RequestMatchers.regexMatchers(regexPatterns));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Associates a list of &#123;<span class="doctag">@link</span> RequestMatcher&#125; instances with the</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> AbstractConfigAttributeRequestMatcherRegistry&#125;</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> requestMatchers the &#123;<span class="doctag">@link</span> RequestMatcher&#125; instances</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the object that is chained after creating the &#123;<span class="doctag">@link</span> RequestMatcher&#125;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> C <span class="title">requestMatchers</span><span class="params">(RequestMatcher... requestMatchers)</span> </span>&#123;</span><br><span class="line">		Assert.state(!<span class="keyword">this</span>.anyRequestConfigured, <span class="string">&quot;Can&#x27;t configure requestMatchers after anyRequest&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> chainRequestMatchers(Arrays.asList(requestMatchers));</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>从以上源码可以看出来,做 任何规则配置之前,都要先判断anyRequest 是否已经配置,如果一已经配置,则会抛出异常</p>
<h3 id="启动测试"><a href="#启动测试" class="headerlink" title="启动测试"></a>启动测试</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST http://localhost:8080/doLogin?username=user03&amp;password=123</span><br><span class="line"><span class="attribute">Accept</span>: */*</span><br><span class="line"><span class="attribute">Cache-Control</span>: no-cache</span><br></pre></td></tr></table></figure>

<p>返回结果:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;password&quot;</span>:<span class="literal">null</span>,<span class="attr">&quot;username&quot;</span>:<span class="string">&quot;user03&quot;</span>,<span class="attr">&quot;authorities&quot;</span>:[&#123;<span class="attr">&quot;authority&quot;</span>:<span class="string">&quot;ROLE_admin&quot;</span>&#125;],<span class="attr">&quot;accountNonExpired&quot;</span>:<span class="literal">true</span>,<span class="attr">&quot;accountNonLocked&quot;</span>:<span class="literal">true</span>,<span class="attr">&quot;credentialsNonExpired&quot;</span>:<span class="literal">true</span>,<span class="attr">&quot;enabled&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<p>登录成功后，分别访问 <code>/hello</code>，<code>/admin/hello</code> 以及 <code>/user/hello</code> 三个接口，其中：</p>
<ol>
<li><code>/hello</code> 因为登录后就可以访问，这个接口访问成功。</li>
<li><code>/admin/hello</code> 需要 admin 身份，所以访问失败。</li>
<li><code>/user/hello</code> 需要 user 身份，所以访问成功。</li>
</ol>
<h3 id="角色继承"><a href="#角色继承" class="headerlink" title="角色继承"></a>角色继承</h3><p>第四条规则是user能够访问的资源,admin都能够访问</p>
<p>现在要去实现user能够访问的资源,admin都能够访问,这涉及到另外一个知识点,叫做角色的继承</p>
<p>这个在实际开发中非常的有用</p>
<p>上级可能具备下级的所有权限.如果使用角色继承,这个功能就很好实现,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">   <span class="function">RoleHierarchy <span class="title">roleHierarchy</span><span class="params">()</span></span>&#123;</span><br><span class="line">       RoleHierarchyImpl roleHierarchy = <span class="keyword">new</span> RoleHierarchyImpl();</span><br><span class="line">       roleHierarchy.setHierarchy(<span class="string">&quot;ROLE_admin &gt; ROLE_user&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span> roleHierarchy;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意，在配置时，需要给角色手动加上 <code>ROLE_</code> 前缀。上面的配置表示 <code>ROLE_admin</code> 自动具备 <code>ROLE_user</code> 的权限</strong></p>
<p>重启项目之后,user03登陆之后也能访问<code>/user/hello</code></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/30/Spring-Security-%E4%B8%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="冯玮">
      <meta itemprop="description" content="以梦为马，明日天涯">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冯玮的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/30/Spring-Security-%E4%B8%80/" class="post-title-link" itemprop="url">Spring Security(一)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-30 16:18:36 / 修改时间：16:19:24" itemprop="dateCreated datePublished" datetime="2020-11-30T16:18:36+08:00">2020-11-30</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Spring-Security"><a href="#Spring-Security" class="headerlink" title="Spring Security"></a>Spring Security</h1><h2 id="1-spring-Security-介绍"><a href="#1-spring-Security-介绍" class="headerlink" title="1. spring Security 介绍"></a>1. spring Security 介绍</h2><p><strong>官网介绍<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-security">Spring Security</a></strong></p>
<blockquote>
<p>Spring Security is a powerful and highly customizable authentication and access-control framework. It is the de-facto standard for securing Spring-based applications.</p>
<p>Spring Security is a framework that focuses on providing both authentication and authorization to Java applications. Like all Spring projects, the real power of Spring Security is found in how easily it can be extended to meet custom requirements</p>
<h2 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h2><ul>
<li>Comprehensive and extensible support for both Authentication and Authorization</li>
<li>Protection against attacks like session fixation, clickjacking, cross site request forgery, etc</li>
<li>Servlet API integration</li>
<li>Optional integration with Spring Web MVC</li>
<li>Much more…</li>
</ul>
</blockquote>
<p>大致意思:</p>
<blockquote>
<p>Spring Security 是一个功能强大且高度可定制的身份验证和访问控制框架。它是保护基于弹簧的应用的实际标准。</p>
<p>Spring Security 是一个框架，它侧重于为 Java 应用程序提供身份验证和授权。与所有春季项目一样，Spring Security 的真正力量也存在于如何轻松扩展以满足自定义要求方面</p>
<h2 id="特征"><a href="#特征" class="headerlink" title="特征"></a>特征</h2><ul>
<li>对身份验证和授权的全面且可扩展的支持</li>
<li>防止会话固定、点击劫持、跨站点请求伪造等攻击</li>
<li>服务 API 集成</li>
<li>可选与弹簧 Web MVC 集成</li>
<li>更多…</li>
</ul>
</blockquote>
<p>Spring Security以前叫做acegi,时候来才成为Spring的一个子项目,也是目前最为流行的一个安全权限管理框架,它与spring紧密结合在一起.</p>
<p>对于一个权限管理框架而言,无论是Shiro还是Spring Security ,最核心的功能无非就是两方面:</p>
<ul>
<li>认证</li>
<li>授权</li>
</ul>
<p>通俗一点说,认证就是我们常说的登录,授权就是权限鉴别,看看请求是否具备相应的权限.</p>
<p>Spring Security 支持多种不同的认证方式,这些认证方式有的是Spring Security 自己提供的认证功能,有的是第三方标准组织制订的,主要有如下一些:</p>
<p>一些比较常见的认证方式:</p>
<ul>
<li>HTTP BASIC authentication headers：基于IETF RFC 标准。</li>
<li>HTTP Digest authentication headers：基于IETF RFC 标准。</li>
<li>HTTP X.509 client certificate exchange：基于IETF RFC 标准。</li>
<li>LDAP：跨平台身份验证。</li>
<li>Form-based authentication：基于表单的身份验证。</li>
<li>Run-as authentication：用户用户临时以某一个身份登录。</li>
<li>OpenID authentication：去中心化认证。</li>
</ul>
<p>除了这些常见的认证方式之外,一些比较冷门的认证方式,Spring Security 也提供了支持</p>
<ul>
<li>Jasig Central Authentication Service：单点登录。</li>
<li>Automatic “remember-me” authentication：记住我登录（允许一些非敏感操作）。</li>
<li>Anonymous authentication：匿名登录。</li>
</ul>
<p>作为一个开放的平台,Spring Security提供的认证机制不仅仅是上面这些,如果上面这些认证机制依然满足不了你的需求,我们也可以自己定制认证逻辑,当我们需要和一些”老破旧”的系统进行集成时,自定义认证逻辑就显得非常重要了,除了认证,剩下的就是授权了</p>
<p>Spring Security支持基于URL的请求授权,支持方法访问授权以及对象访问授权 </p>
<h2 id="2-创建Spring-Security项目"><a href="#2-创建Spring-Security项目" class="headerlink" title="2. 创建Spring  Security项目"></a>2. 创建Spring  Security项目</h2><h3 id="1-新建项目"><a href="#1-新建项目" class="headerlink" title="1.新建项目"></a>1.新建项目</h3><p>首先创建一个Springboot项目,创建时引入SpringSecurity依赖和web依赖如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建成功后,我们添加一个测试的<code>HelloController</code>,内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动项目,启动项目过程中,我们会看到一行日志:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Using generated security password: c196c586-bc2d-<span class="number">47f</span>9-a73a-<span class="number">5426f</span>b3a5c4c</span><br></pre></td></tr></table></figure>

<p>这个就是SpringSecurity 为默认用户<code>user</code> 生成的临时密码,是一个UUID字符串.接下来我们去访问</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/login">http://localhost:8080/login</a> ,会重定向到这个页面</p>
<p><img src="C:\Users\fengwei\AppData\Roaming\Typora\typora-user-images\image-20201130101547227.png" alt="image-20201130101547227"></p>
<p>在登录页面,使用默认的用户名<code>user</code>,默认的登录密码就是项目启动的时候控制台打印出来的密码,输入用户名密码之后,就显示登录成功了,登录成功后,我们就可以访问到<code>/hello</code>接口了</p>
<p>在spring security中,默认的登录页面和的路入口都是<code>/login</code>只不过一个是<code>get</code>(登录页面)请求,另一个是<code>post</code>请求(登录接口)</p>
<p>以上就是springsecurity的一个简单的使用介绍,使用起来还是很简单的,并且一个依赖就保护了所有的接口</p>
<p>到这里就是想知道,为什么说临时生成的密码是UUID?</p>
<p>看源码中,<code>UserDetailsServiceAutoConfiguration</code> 和用户相关的自动化配置类中,在该类的<code>getOrDeducePassword</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getOrDeducePassword</span><span class="params">(User user, PasswordEncoder encoder)</span> </span>&#123;</span><br><span class="line">       String password = user.getPassword();</span><br><span class="line">       <span class="keyword">if</span> (user.isPasswordGenerated()) &#123;</span><br><span class="line">           logger.info(String.format(<span class="string">&quot;%n%nUsing generated security password: %s%n&quot;</span>, user.getPassword()));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> encoder == <span class="keyword">null</span> &amp;&amp; !PASSWORD_ALGORITHM_PATTERN.matcher(password).matches() ? <span class="string">&quot;&#123;noop&#125;&quot;</span> + password : password;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在控制台中我们看到的日志,就是这句话打印出来的,所以得知<code>user.isPasswordGenerated()</code>返回的是<code>true</code></p>
<p>在User的类中我们发现(部分代码):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String name = <span class="string">&quot;user&quot;</span>;</span><br><span class="line">        <span class="keyword">private</span> String password = UUID.randomUUID().toString();</span><br><span class="line">        <span class="keyword">private</span> List&lt;String&gt; roles = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> passwordGenerated = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的代码中,可以看到,默认的用户名就是user,默认的密码则是UUID,而默认情况下,<code>passwordGenerated</code>也是true.</p>
<h3 id="2-用户配置"><a href="#2-用户配置" class="headerlink" title="2.用户配置"></a>2.用户配置</h3><p>使用默认密码在代码上很好实现,但是每次重新启动都是新的密码,这对用户来说很不方便,在正式使用数据库连接之前,先介绍两种非主流的用户名/密码配置方案</p>
<h4 id="2-1-配置文件"><a href="#2-1-配置文件" class="headerlink" title="2.1 配置文件"></a>2.1 配置文件</h4><p>我们可以再<code>application.properties</code>中配置默认的用户名密码</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.security.user.name</span>=<span class="string">user01</span></span><br><span class="line"><span class="meta">spring.security.user.password</span>=<span class="string">123</span></span><br></pre></td></tr></table></figure>

<p>以上就是我们新定义的用户名和密码</p>
<p>在<code>properites</code>中定义的用户名和密码最终是通过set方法注入到属性中去的,这里我们顺便来看下,<code>SecurityProperties.User setPassword</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasLength(password)) &#123;</span><br><span class="line">                <span class="keyword">this</span>.passwordGenerated = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">this</span>.password = password;</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从这里我们可以看到<code>,application.properties</code>中定义的密码在注入进来之后,还顺便设置了<code>passwordGenerated =false</code>,这个属性设置为<code>false</code>之后,控制台就不会打印默认的密码了,此时重启之后就可以使用自己定义的用户名和密码登录了</p>
<h4 id="2-2-配置类"><a href="#2-2-配置类" class="headerlink" title="2.2 配置类"></a>2.2 配置类</h4><p>除了上面的配置文件的方式以外,还可以在配置类中配置用户名/密码,在配置类中配置,我们就要指定<code>PasswordEncoder了</code>,这是一个非常关键的东西</p>
<p>密码加密我们一般会用到散列函数，又称散列算法、哈希函数，这是一种从任何数据中创建数字“指纹”的方法。散列函数把消息或数据压缩成摘要，使得数据量变小，将数据的格式固定下来，然后将数据打乱混合，重新创建一个散列值。散列值通常用一个短的随机字母和数字组成的字符串来代表。好的散列函数在输入域中很少出现散列冲突。在散列表和数据处理中，不抑制冲突来区别数据，会使得数据库记录更难找到。我们常用的散列函数有 MD5 消息摘要算法、安全散列算法（Secure Hash Algorithm）。</p>
<p>但是仅仅使用散列函数还不够，为了增加密码的安全性，一般在密码加密过程中还需要加盐，所谓的盐可以是一个随机数也可以是用户名，加盐之后，即使密码明文相同的用户生成的密码密文也不相同，这可以极大的提高密码的安全性。但是传统的加盐方式需要在数据库中有专门的字段来记录盐值，这个字段可能是用户名字段（因为用户名唯一），也可能是一个专门记录盐值的字段，这样的配置比较繁琐。</p>
<p>Spring Security 提供了多种密码加密方案，官方推荐使用 <code>BCryptPasswordEncoder</code>，<code>BCryptPasswordEncoder</code> 使用 <code>BCrypt</code> 强哈希函数，开发者在使用时可以选择提供 <code>strength</code> 和 <code>SecureRandom</code> 实例。strength 越大，密钥的迭代次数越多，密钥迭代次数为 2^strength。strength 取值在 4~31 之间，默认为 10。</p>
<p><code>PasswordEncoder</code>这个接口定义了三个方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PasswordEncoder</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">encode</span><span class="params">(CharSequence var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(CharSequence var1, String var2)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">upgradeEncoding</span><span class="params">(String encodedPassword)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>encode 方法用来对明文密码进行加密,返回加密之后的密文</li>
<li>matches 方法是一个密码校对方法,在用户登录的时候,将用户传来的明文密码和数据库中保存的密文密码作为参数,传入到这个方法中去,根据返回的Boolean值判断用户密码是否输入正确.</li>
<li><code>upgradeEncoding</code> 是否还要进行再次加密,这一一般来说就不用了</li>
</ul>
<p>通过下图,我们可以看到<code>PasswordEncoder</code> 的实现类</p>
<p><img src="C:\Users\fengwei\AppData\Roaming\Typora\typora-user-images\image-20201130105608197.png" alt="image-20201130105608197"></p>
<p>配置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> NoOpPasswordEncoder.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        auth.inMemoryAuthentication()</span><br><span class="line">                .withUser(<span class="string">&quot;User01&quot;</span>)</span><br><span class="line">                .password(<span class="string">&quot;123&quot;</span>).roles(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>首先我们自定义<code>SecyrityConfig</code>继承<code>WebSecurityConfigAdapter</code>,重写里边的<code>configure</code>方法</p>
</li>
<li><p>我们需要提供一个<code>PasswordEncoder</code>的实例,因为目前的案例还比较单单,因此我们暂时下不给密码加密,所以返回<code>NoOpPasswordEncoder</code>的实例即可</p>
</li>
<li><p>configure中我们通过<code>inMemoryAuthentication</code>来开启在内存中定义用户,<code>withUser</code>中是用户名,password是密码.roles中是用户角色</p>
</li>
<li><p>如果配置多个用户,用and相连</p>
<p>为什么用<code>and</code>相连?</p>
<blockquote>
<p>没有 Spring Boot 的时候，我们都是 SSM 中使用 Spring Security，这种时候都是在 XML 文件中配置 Spring Security，既然是 XML 文件，标签就有开始有结束，现在的 and 符号相当于就是 XML 标签的结束符，表示结束当前标签，这是个时候上下文会回到 <code>inMemoryAuthentication </code>方法中，然后开启新用户的配置。</p>
</blockquote>
<p>配置完成后,再次启动项目,java代码中的配置会覆盖掉xml文件中的配置,此时再去访问<code>/hello</code>接口,就会发现只有java代码中的用户名/密码才能访问成功</p>
</li>
</ol>
<h3 id="3-自定义表单登录页"><a href="#3-自定义表单登录页" class="headerlink" title="3. 自定义表单登录页"></a>3. 自定义表单登录页</h3><p>自定义一个登录页面:</p>
<h4 id="3-1-服务端定义"><a href="#3-1-服务端定义" class="headerlink" title="3.1 服务端定义"></a>3.1 服务端定义</h4><p>然后接下来我们继续完善前面的SecurityConfig类,继续重写它的configure(WebSecurity web) 和configure(HttpSecurity http) 方法,如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    web.ignoring().antMatchers(<span class="string">&quot;/js/**&quot;</span>, <span class="string">&quot;/css/**&quot;</span>, <span class="string">&quot;images/**&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http.authorizeRequests()</span><br><span class="line">            .anyRequest().authenticated()</span><br><span class="line">            .and()</span><br><span class="line">            .formLogin()</span><br><span class="line">            .loginPage(<span class="string">&quot;/login/html&quot;</span>)</span><br><span class="line">            .permitAll()</span><br><span class="line">            .and()</span><br><span class="line">            .csrf().disable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>web.ignoring() </code>用来忽略掉的URL地址,一般对于静态文件,我们可以采用此 操作</li>
<li>如果我们使用XML来配置<code>SpringSecurity</code>,里面会有一个重要的标签,<http>,<code>HttpSecurity</code>提供的配置方法都对应了该标签</li>
<li><code>authorizeResquests</code>对应了<intercept-url></li>
<li><code>formLogin</code>对应了<formlogin></li>
<li><code>and</code>方法标识结束当前标签,上下文回到<code>HttpSecurity</code>,开启新一轮的配置</li>
<li><code>permitAll</code>标识登录相关的页面/接口不要拦截</li>
<li>最后记得关闭<code>crsf</code>,关于<code>crsf</code>问题到后门会有详细解释</li>
</ol>
<p>当我们定义了登录的页面为<code>/login.html</code>的时候,SpringSecurity也会帮助我们自动注册一个/login.html的接口,这个接口是<code>POST</code>请求.用来处理登录逻辑</p>
<h4 id="3-2-前端定义"><a href="#3-2-前端定义" class="headerlink" title="3.2 前端定义"></a>3.2 前端定义</h4><p>我们将登录页面的相关静态文件放到springboot项目的resources/static目录下:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;title&quot;</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/login.html&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;name&quot;</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">id</span>=<span class="string">&quot;name&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;spin&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;pass&quot;</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">id</span>=<span class="string">&quot;pass&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;spin&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;button login&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-check&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:&quot;</span> <span class="attr">class</span>=<span class="string">&quot;pass-forgot&quot;</span>&gt;</span>忘记密码？<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>form表单中,注意action为<code>/login.html</code>,配置完成此时重启再去访问,都会定向到我们定义的这个页面上来,输入用户名密码就可以登录了</p>
<h4 id="3-3登录参数"><a href="#3-3登录参数" class="headerlink" title="3.3登录参数"></a>3.3登录参数</h4><p>默认的登录参数是<code>username</code>,<code>password</code>,注意默认情况下,这个不能变, </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/login.html&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">id</span>=<span class="string">&quot;name&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">id</span>=<span class="string">&quot;pass&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code> FormLoginConfigurer</code> 类中，在它的构造方法中，我们可以看到有两个配置用户名密码的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FormLoginConfigurer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>(<span class="keyword">new</span> UsernamePasswordAuthenticationFilter(), <span class="keyword">null</span>);</span><br><span class="line">	usernameParameter(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">	passwordParameter(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里，首先<code>super</code>调用了父类的构造方法，传入了 <code>UsernamePasswordAuthenticationFilter </code>实例，该实例将被赋值给父类的 <code>authFilter</code> 属性。</p>
<p>接下来<code>usernameParameter</code>方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> FormLoginConfigurer&lt;H&gt; <span class="title">usernameParameter</span><span class="params">(String usernameParameter)</span> </span>&#123;</span><br><span class="line">		getAuthenticationFilter().setUsernameParameter(usernameParameter);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的设置,当登录请求从浏览器来到服务端之后,我们要从请求的<code>HttpServelRequest</code>中取出来用户的登录用户名和登录密码,怎么取呢?还是在UsernamePasswordAuthenticationFilter类中,有如下两个方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">obtainUsername</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> request.getParameter(<span class="keyword">this</span>.usernameParameter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">obtainPassword</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> request.getParameter(<span class="keyword">this</span>.passwordParameter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到,这个时候,就用到默认配置的username和password了,</p>
<p>当然这两个参数我们也可以自己配置,自己配置的方式如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.and()</span><br><span class="line">.formLogin()</span><br><span class="line">.loginPage(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">.loginProcessingUrl(<span class="string">&quot;/doLogin&quot;</span>)</span><br><span class="line">.usernameParameter(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">.passwordParameter(<span class="string">&quot;passwd&quot;</span>)</span><br><span class="line">.permitAll()</span><br><span class="line">.and()</span><br></pre></td></tr></table></figure>

<p>配置完成后记得修改一下前端页面:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/doLogin&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;name&quot;</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">id</span>=<span class="string">&quot;name&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;spin&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;pass&quot;</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;passwd&quot;</span> <span class="attr">id</span>=<span class="string">&quot;pass&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;spin&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;button login&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-check&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意修改input的name属性值和服务端的对应</p>
<h4 id="3-4-登录回调"><a href="#3-4-登录回调" class="headerlink" title="3.4 登录回调"></a>3.4 登录回调</h4><p>在登陆成功之后,我们就要分情况处理了,大体上来说,无非就是分为两种情况:</p>
<ul>
<li>前后端分离登录</li>
<li>前后端不分登录</li>
</ul>
<p>两种情况的处理方式不一样,本文我们先来第二种前后不分的登录</p>
<p>在<code>SpringSecurity</code>中,和登录成功重定向的URL相关的方法有两个:</p>
<ul>
<li><code>defaultSuccessUrl</code></li>
<li><code>successForwardUrl</code></li>
</ul>
<p>我们在实际配置的时候,只需要配置一个即可,具体配置哪个,要看你的需求,两个的区别如下:</p>
<ol>
<li><code>defaultSuccessUrl </code>有一个重载的方法，我们先说一个参数的 <code>defaultSuccessUrl</code> 方法。如果我们在<code> defaultSuccessUrl</code> 中指定登录成功的跳转页面为 <code>/index</code>，此时分两种情况，如果你是直接在浏览器中输入的登录地址，登录成功后，就直接跳转到 <code>/index</code>，如果你是在浏览器中输入了其他地址，例如 <code>http://localhost:8080/hello</code>，结果因为没有登录，又重定向到登录页面，此时登录成功后，就不会来到 <code>/index</code> ，而是来到 <code>/hello</code> 页面。</li>
<li><code>defaultSuccessUrl</code> 还有一个重载的方法，第二个参数如果不设置默认为 false，也就是我们上面的的情况，如果手动设置第二个参数为 true，则 <code>defaultSuccessUrl</code> 的效果和 <code>successForwardUrl </code>一致。</li>
<li><code>successForwardUrl </code>表示不管你是从哪里来的，登录后一律跳转到<code> successForwardUrl</code> 指定的地址。例如 <code>successForwardUrl </code>指定的地址为 <code>/index</code> ，你在浏览器地址栏输入 <code>http://localhost:8080/hello</code>，结果因为没有登录，重定向到登录页面，当你登录成功之后，就会服务端跳转到 <code>/index</code> 页面；或者你直接就在浏览器输入了登录页面地址，登录成功后也是来到 <code>/index</code>。</li>
</ol>
<p>相关配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.and()</span><br><span class="line">.formLogin()</span><br><span class="line">.loginPage(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">.loginProcessingUrl(<span class="string">&quot;/doLogin&quot;</span>)</span><br><span class="line">.usernameParameter(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">.passwordParameter(<span class="string">&quot;passwd&quot;</span>)</span><br><span class="line">.defaultSuccessUrl(<span class="string">&quot;/index&quot;</span>)</span><br><span class="line">.successForwardUrl(<span class="string">&quot;/index&quot;</span>)</span><br><span class="line">.permitAll()</span><br><span class="line">.and()</span><br></pre></td></tr></table></figure>



<p><strong>注意:实际操作中,<code>defaultSuccessUrl</code>和<code>successForwardUrl</code>只需要配置一个即可</strong></p>
<h4 id="3-5-登录失败回调"><a href="#3-5-登录失败回调" class="headerlink" title="3.5 登录失败回调"></a>3.5 登录失败回调</h4><p>与登录成功相似,登录失败也是两个方法:</p>
<ul>
<li><code>failureForeardUrl</code></li>
<li><code>failureUrl</code></li>
</ul>
<p>这两个方法在设置的时候也是设置一个即可,<code>failForwardUrl</code>是登录失败之后会发生服务端跳转,<code>failureUrl</code>则在登录失败之后,会发生重定向</p>
<h4 id="3-6-注销登录"><a href="#3-6-注销登录" class="headerlink" title="3.6 注销登录"></a>3.6 注销登录</h4><p>注销登录的默认接口是<code>/logout</code>,我们也可以配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.and()</span><br><span class="line">.logout()</span><br><span class="line">.logoutUrl(<span class="string">&quot;/logout&quot;</span>)</span><br><span class="line">.logoutRequestMatcher(<span class="keyword">new</span> AntPathRequestMatcher(<span class="string">&quot;/logout&quot;</span>,<span class="string">&quot;POST&quot;</span>))</span><br><span class="line">.logoutSuccessUrl(<span class="string">&quot;/index&quot;</span>)</span><br><span class="line">.deleteCookies()</span><br><span class="line">.clearAuthentication(<span class="keyword">true</span>)</span><br><span class="line">.invalidateHttpSession(<span class="keyword">true</span>)</span><br><span class="line">.permitAll()</span><br><span class="line">.and()</span><br></pre></td></tr></table></figure>

<p>注销登录的配置我来说一下：</p>
<ol>
<li>默认注销的 URL 是 <code>/logout</code>，是一个 GET 请求，我们可以通过<code>logoutUrl</code>方法来修改默认的注销 URL。</li>
<li><code>logoutRequestMatcher</code> 方法不仅可以修改注销 URL，还可以修改请求方式，实际项目中，这个方法和 <code>logoutUrl </code>任意设置一个即可。</li>
<li><code>logoutSuccessUrl </code>表示注销成功后要跳转的页面。</li>
<li><code>deleteCookies</code> 用来清除 cookie。</li>
<li><code>clearAuthentication</code> 和<code>invalidateHttpSession</code>分别表示清除认证信息和使<code>HttpSession</code>失效，默认可以不用配置，默认就会清除。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/26/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="冯玮">
      <meta itemprop="description" content="以梦为马，明日天涯">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冯玮的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/26/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">设计模式-责任链模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-26 14:20:34 / 修改时间：14:26:09" itemprop="dateCreated datePublished" datetime="2020-11-26T14:20:34+08:00">2020-11-26</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="设计模式–责任链模式"><a href="#设计模式–责任链模式" class="headerlink" title="设计模式–责任链模式"></a>设计模式–责任链模式</h1><h2 id="责任链模式介绍"><a href="#责任链模式介绍" class="headerlink" title="责任链模式介绍"></a>责任链模式介绍</h2><p>责任链,顾名思义,就是用来处理相关责任的一条执行链,执行链上有很多个节点,每个节点,都有机会(条件匹配)处理请求事务.如果某个节点处理完了就可以根据实际业务需求传递给下一个节点继续处理或者返回处理完毕</p>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>现实中请假的OA申请,请假天数如果是半天到1天,可能直接主管批准即可:</p>
<p>如果是1到3天,需要部门经理批准,</p>
<p>如果是3到30天,则需要总经理审批;</p>
<p>大于30天正常不会批准</p>
<h2 id="类图"><a href="#类图" class="headerlink" title="类图"></a>类图</h2><p>为了实现 上述场景.我们可以采用责任链模式</p>
<ul>
<li>员工提交请求类:<code>LeaveRequest</code></li>
<li>抽象的请假责任处理类:<code>AbstractLeaveHandler</code></li>
<li>直接主管审批处理类: <code>DirectLeaveHandler</code></li>
<li>部门经理处理类:<code>DeptManagerLeaveHandler</code></li>
<li>总经理处理类:<code>GManagerLeaveHandler</code></li>
</ul>
<p>员工请求发起申请到抽象的责任处理类中,根据员工的请假天数,对应处理类完成处理.每个责任处理类设置下面的节点.自身处理不了的则传递给下一个节点处理</p>
<p><img src="http://c.biancheng.net/uploads/allimg/181116/3-1Q116135Z11C.gif" alt="责任链模式的结构图"></p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>员工提交请求类:<code>LeaveRequest</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LeaveRequest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> leaveDays;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LeaveRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LeaveRequest</span><span class="params">(<span class="keyword">int</span> leaveDays, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.leaveDays = leaveDays;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLeaveDays</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> leaveDays;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLeaveDays</span><span class="params">(<span class="keyword">int</span> leaveDays)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.leaveDays = leaveDays;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>抽象的请假责任处理类:<code>AbstractLeaveHandler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractLeaveHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  <span class="keyword">int</span> MIN = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">protected</span>  <span class="keyword">int</span> MIDDLE = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">protected</span>  <span class="keyword">int</span> MAX = <span class="number">30</span>;</span><br><span class="line">    <span class="keyword">protected</span> String handlerName;</span><br><span class="line">    <span class="keyword">protected</span> AbstractLeaveHandler nextHandler;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setNextHandler</span><span class="params">(AbstractLeaveHandler nextHandler)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.nextHandler = nextHandler;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">handlerRequest</span><span class="params">(LeaveRequest leaveRequest)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接主管审批处理类: <code>DirectLeaveHandler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DirectLeaderLeaveHandler</span> <span class="keyword">extends</span> <span class="title">AbstractLeaveHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DirectLeaderLeaveHandler</span><span class="params">(String handlerName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.handlerName = handlerName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">handlerRequest</span><span class="params">(LeaveRequest leaveRequest)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.MIN&gt;=leaveRequest.getLeaveDays())&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;直接领导审批完成&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> != <span class="keyword">this</span>.nextHandler)&#123;</span><br><span class="line">            <span class="keyword">this</span>.nextHandler.handlerRequest(leaveRequest);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;拒绝审批&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>部门经理处理类:<code>DeptManagerLeaveHandler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeptManagerLeaveHandler</span> <span class="keyword">extends</span> <span class="title">AbstractLeaveHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DeptManagerLeaveHandler</span><span class="params">(String handlerName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.handlerName = handlerName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handlerRequest</span><span class="params">(LeaveRequest leaveRequest)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.MIN &lt; leaveRequest.getLeaveDays() &amp;&amp; <span class="keyword">this</span>.MIDDLE &gt;= leaveRequest.getLeaveDays()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;部门经理:&quot;</span> + handlerName + <span class="string">&quot;,已经处理;流程结束。&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != <span class="keyword">this</span>.nextHandler) &#123;</span><br><span class="line">            <span class="keyword">this</span>.nextHandler.handlerRequest(leaveRequest);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;拒绝审批&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总经理处理类:<code>GManagerLeaveHandler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GManagerLeaverHandler</span> <span class="keyword">extends</span> <span class="title">AbstractLeaveHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GManagerLeaverHandler</span><span class="params">(String handlerName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.handlerName = handlerName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">handlerRequest</span><span class="params">(LeaveRequest leaveRequest)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.MIDDLE&lt;=leaveRequest.getLeaveDays() &amp;&amp; <span class="keyword">this</span>.MAX&gt;=leaveRequest.getLeaveDays())&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;总经理审批成功&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> != <span class="keyword">this</span>.nextHandler)&#123;</span><br><span class="line">            <span class="keyword">this</span>.nextHandler.handlerRequest(leaveRequest);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;拒绝审批&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LeaveTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        LeaveRequest leaveRequest = <span class="keyword">new</span> LeaveRequest(<span class="number">4</span>, <span class="string">&quot;张三&quot;</span>);</span><br><span class="line">        DirectLeaderLeaveHandler directLeaderLeaveHandler = <span class="keyword">new</span> DirectLeaderLeaveHandler(<span class="string">&quot;直接领导&quot;</span>);</span><br><span class="line">        DeptManagerLeaveHandler deptManagerLeaveHandler = <span class="keyword">new</span> DeptManagerLeaveHandler(<span class="string">&quot;部门领导&quot;</span>);</span><br><span class="line">        GManagerLeaverHandler gManagerLeaverHandler = <span class="keyword">new</span> GManagerLeaverHandler(<span class="string">&quot;总经理&quot;</span>);</span><br><span class="line">        directLeaderLeaveHandler.setNextHandler(deptManagerLeaveHandler);</span><br><span class="line">        deptManagerLeaveHandler.setNextHandler(gManagerLeaverHandler);</span><br><span class="line"></span><br><span class="line">        directLeaderLeaveHandler.handlerRequest(leaveRequest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个模式的好处在于弱化请求方和处理方的关联关系，让双方都可以成为独立复用的组件。缺点也很明显，链上的节点太长的话会影响性能。</p>
<p>另外，此模式也不要一言不合就滥用于替换if-else的代码，因为此模式的设计重点不在于选择逻辑的判断，而是转移责任，即谁负责处理的这一个事件。应用上还是要具体情况具体分析~</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/25/SpringBoot-%E6%95%B4%E5%90%88cxf%E5%AE%9E%E7%8E%B0webservice%E5%8F%91%E5%B8%83%E5%92%8C%E8%B0%83%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="冯玮">
      <meta itemprop="description" content="以梦为马，明日天涯">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冯玮的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/25/SpringBoot-%E6%95%B4%E5%90%88cxf%E5%AE%9E%E7%8E%B0webservice%E5%8F%91%E5%B8%83%E5%92%8C%E8%B0%83%E7%94%A8/" class="post-title-link" itemprop="url">SpringBoot 整合cxf实现webservice发布和调用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-25 15:38:43 / 修改时间：15:39:14" itemprop="dateCreated datePublished" datetime="2020-11-25T15:38:43+08:00">2020-11-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="SpringBoot-整合cxf发布WebService服务"><a href="#SpringBoot-整合cxf发布WebService服务" class="headerlink" title="SpringBoot 整合cxf发布WebService服务"></a>SpringBoot 整合cxf发布WebService服务</h1><h2 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.cxf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cxf-spring-boot-starter-jaxws<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="服务端接口"><a href="#服务端接口" class="headerlink" title="服务端接口"></a>服务端接口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.jws.WebMethod;</span><br><span class="line"><span class="keyword">import</span> javax.jws.WebService;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 命名空间,一般是接口的包名倒序</span></span><br><span class="line"><span class="meta">@WebService(targetNamespace = &quot;http://impl.service.webservice.yinhai.com/&quot;)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DemoService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@WebMethod(operationName = &quot;say&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">say</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="服务端接口实现"><a href="#服务端接口实现" class="headerlink" title="服务端接口实现"></a>服务端接口实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoServiceImpl</span> <span class="keyword">implements</span> <span class="title">DemoService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">say</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;java&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="cxf-配置"><a href="#cxf-配置" class="headerlink" title="cxf 配置"></a>cxf 配置</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.yinhai.webservice.service.impl.DemoServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.cxf.Bus;</span><br><span class="line"><span class="keyword">import</span> org.apache.cxf.bus.spring.SpringBus;</span><br><span class="line"><span class="keyword">import</span> org.apache.cxf.endpoint.Client;</span><br><span class="line"><span class="keyword">import</span> org.apache.cxf.jaxws.EndpointImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.cxf.jaxws.endpoint.dynamic.JaxWsDynamicClientFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.cxf.transport.servlet.CXFServlet;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.ServletRegistrationBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.ws.Endpoint;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebServiceConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(WebServiceConfig.class);</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">disServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//默认服务在Host:port/services/*下,这里可以设置成 Host:port/webServices/*下</span></span><br><span class="line">        ServletRegistrationBean servletRegistrationBean = <span class="keyword">new</span> ServletRegistrationBean(<span class="keyword">new</span> CXFServlet(), <span class="string">&quot;/webServices/*&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> servletRegistrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean(name = Bus.DEFAULT_BUS_ID)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SpringBus <span class="title">springBus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringBus();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Endpoint <span class="title">endpoint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        EndpointImpl endpoint = <span class="keyword">new</span> EndpointImpl(springBus(), <span class="keyword">new</span> DemoServiceImpl());</span><br><span class="line">        endpoint.publish(<span class="string">&quot;/userService&quot;</span>);</span><br><span class="line">        logger.info(endpoint.getWsdlLocation());</span><br><span class="line">        <span class="keyword">return</span> endpoint;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问地址: <a target="_blank" rel="noopener" href="http://localhost:8083/ta404/webServices/userService?wsdl">localhost:8083/ta404/webServices/userService?wsdl</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">wsdl:definitions</span> <span class="attr">xmlns:xsd</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> <span class="attr">xmlns:wsdl</span>=<span class="string">&quot;http://schemas.xmlsoap.org/wsdl/&quot;</span> <span class="attr">xmlns:tns</span>=<span class="string">&quot;http://impl.service.webservice.yinhai.com/&quot;</span> <span class="attr">xmlns:soap</span>=<span class="string">&quot;http://schemas.xmlsoap.org/wsdl/soap/&quot;</span> <span class="attr">xmlns:ns2</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/http&quot;</span> <span class="attr">xmlns:ns1</span>=<span class="string">&quot;http://service.springbootcxfdemo.demo.com&quot;</span> <span class="attr">name</span>=<span class="string">&quot;DemoServiceImplService&quot;</span> <span class="attr">targetNamespace</span>=<span class="string">&quot;http://impl.service.webservice.yinhai.com/&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">wsdl:import</span> <span class="attr">location</span>=<span class="string">&quot;http://localhost:8083/ta404/webServices/userService?wsdl=DemoService.wsdl&quot;</span> <span class="attr">namespace</span>=<span class="string">&quot;http://service.springbootcxfdemo.demo.com&quot;</span>&gt;</span> <span class="tag">&lt;/<span class="name">wsdl:import</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">wsdl:binding</span> <span class="attr">name</span>=<span class="string">&quot;DemoServiceImplServiceSoapBinding&quot;</span> <span class="attr">type</span>=<span class="string">&quot;ns1:DemoService&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">soap:binding</span> <span class="attr">style</span>=<span class="string">&quot;document&quot;</span> <span class="attr">transport</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/http&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">wsdl:operation</span> <span class="attr">name</span>=<span class="string">&quot;say&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">soap:operation</span> <span class="attr">soapAction</span>=<span class="string">&quot;&quot;</span> <span class="attr">style</span>=<span class="string">&quot;document&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">wsdl:input</span> <span class="attr">name</span>=<span class="string">&quot;say&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">soap:body</span> <span class="attr">use</span>=<span class="string">&quot;literal&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">wsdl:input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">wsdl:output</span> <span class="attr">name</span>=<span class="string">&quot;sayResponse&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">soap:body</span> <span class="attr">use</span>=<span class="string">&quot;literal&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">wsdl:output</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">wsdl:operation</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">wsdl:binding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">wsdl:service</span> <span class="attr">name</span>=<span class="string">&quot;DemoServiceImplService&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">wsdl:port</span> <span class="attr">binding</span>=<span class="string">&quot;tns:DemoServiceImplServiceSoapBinding&quot;</span> <span class="attr">name</span>=<span class="string">&quot;DemoServiceImplPort&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">soap:address</span> <span class="attr">location</span>=<span class="string">&quot;http://localhost:8083/ta404/webServices/userService&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">wsdl:port</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">wsdl:service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">wsdl:definitions</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="客户端调用"><a href="#客户端调用" class="headerlink" title="客户端调用"></a>客户端调用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建动态客户端</span></span><br><span class="line">        JaxWsDynamicClientFactory dcf = JaxWsDynamicClientFactory.newInstance();</span><br><span class="line">        Client client = dcf.createClient(<span class="string">&quot;http://127.0.0.1:8083/ta404/webServices/userService?wsdl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 需要密码的情况需要加上用户名和密码</span></span><br><span class="line">        <span class="comment">// client.getOutInterceptors().add(new ClientLoginInterceptor(USER_NAME,PASS_WORD));</span></span><br><span class="line">        Object[] objects = <span class="keyword">new</span> Object[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// invoke(&quot;方法名&quot;,参数1,参数2,参数3....);</span></span><br><span class="line">            objects = client.invoke(<span class="string">&quot;say&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;返回数据:&quot;</span> + objects[<span class="number">0</span>]);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (java.lang.Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//结果输出</span></span><br><span class="line"> 返回数据:java</span><br></pre></td></tr></table></figure>

<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>在一些框架中可能会被认证拦截?</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;code&quot;</span>:<span class="number">200</span>,<span class="attr">&quot;data&quot;</span>:&#123;&#125;,<span class="attr">&quot;errors&quot;</span>:[&#123;<span class="attr">&quot;errorCode&quot;</span>:<span class="string">&quot;403&quot;</span>,<span class="attr">&quot;msg&quot;</span>:<span class="string">&quot;未登录&quot;</span>,<span class="attr">&quot;parameter&quot;</span>:<span class="string">&quot;\/ta404\/webServices\/userServicwe&quot;</span>&#125;],<span class="attr">&quot;redirectUrl&quot;</span>:<span class="literal">null</span>,<span class="attr">&quot;requestId&quot;</span>:<span class="literal">null</span>,<span class="attr">&quot;serviceSuccess&quot;</span>:<span class="literal">false</span>&#125;</span><br></pre></td></tr></table></figure>

<p>解决方式: 在<code>yml</code>配置文件中把暴露出来的webservice地址配置成<code>无需登录就可以访问的地址</code></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">component:</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">permit-urls:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/webServices/userService</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/25/java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="冯玮">
      <meta itemprop="description" content="以梦为马，明日天涯">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冯玮的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/25/java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">java多线程的创建和使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-25 08:55:30 / 修改时间：08:56:07" itemprop="dateCreated datePublished" datetime="2020-11-25T08:55:30+08:00">2020-11-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="线程概述与线程创建和使用"><a href="#线程概述与线程创建和使用" class="headerlink" title="线程概述与线程创建和使用"></a>线程概述与线程创建和使用</h1><h2 id="1-线程概述"><a href="#1-线程概述" class="headerlink" title="1.线程概述"></a>1.线程概述</h2><p><code>进程</code>是表示资源分配的基本单位.又是调度运行的基本单位.例如:用户运行自己的程序,系统就创建一个进程,并为他分配资源,包括各种表格,内存空间,磁盘空间,I/O设备等,然后把该进程放入进程的就绪队列,进程调度程序选中它,为他分配CPU以及其他有关资源,该进程才真正运行,所以进程是系统中的并发执行的单位.如下图所示,在windows中通过查看任务管理器的方式,我们就可以清楚的看到windows当前运行的进行</p>
<p><img src="https://img-blog.csdnimg.cn/20191102171113712.png" alt="在这里插入图片描述"></p>
<p><code>线程</code>是进程中执行运算的最小单位,亦即执行处理机调度的基本单位.如果把进程理解为在逻辑上操作系统所完成的任务，那么线程表示完成该任务的许多可能的子任务之一。例如，假设用户启动了一个窗口中的数据库应用程序，操作系统就将对数据库的调用表示为一个进程。假设用户要从数据库中产生一份工资单报表，并传到一个文件中，这是一个子任务；在产生工资单报表的过程中，用户又可以输人数据库查询请求，这又是一个子任务。这样，操作系统则把每一个请求――工资单报表和新输人的数据查询表示为数据库进程中的独立的线程。线程可以在处理器上独立调度执行，这样，在多处理器环境下就允许几个线程各自在单独处理器上进行。操作系统提供线程就是为了方便而有效地实现这种并发性。</p>
<p>一个cpu在任意时刻，只能执行一个线程任务，我们平时一边浏览网页，一边听音乐的场景其实是依赖cpu高速地线程间切换实现地，这也引出了一组容易混淆地概念：**并发(Concurrency)和并行(Parallelism)**。</p>
<p>它们都可以表示两个或者多个任务一起执行，但是偏重点有些不同。并发偏重于多个任务交替执行，而多个任务之间有可能还是串行的，而并行是真正意义上的“同时执行”，它依赖于多核cpu而实现</p>
<p>引入线程的好处:</p>
<ul>
<li>易于调度</li>
<li>提高并发性,通过线程可方便有效地实现并发性,进程可创建多个线程来执行同一程序的不同部分</li>
<li>开销小,创建线程比创建进程要快,所需开销很少</li>
<li>利于充分发挥多处理器的功能,通过创建多线程进程,每个线程在一个处理器上运行.从而实现应用程序的并发性.使每一个处理器都得到充分运行</li>
</ul>
<p>进程和线程的关系:</p>
<ul>
<li>一个线程只能属于一个进程，而一个进程可以有多个线程，但至少有一个线程。线程是操作系统可识别的最小执行和调度单位。</li>
<li>资源分配给进程，同一进程的所有线程共享该进程的所有资源。 同一进程中的多个线程共享代码段(代码和常量)，数据段(全局变量和静态变量)，扩展段(堆存储)。但是每个线程拥有自己的栈段，栈段又叫运行时段，用来存放所有局部变量和临时变量。</li>
<li>处理机分给线程，即真正在处理机上运行的是线程。</li>
<li>线程在执行过程中，需要协作同步。不同进程的线程间要利用消息通信的办法实现同步。</li>
</ul>
<p>###　１.1线程生命周期</p>
<p>线程是一个动态执行的过程,它也有一个从生产到死亡的过程:</p>
<p><img src="https://img-blog.csdnimg.cn/2019110217044331.png" alt="在这里插入图片描述"></p>
<ol>
<li>新建状态:New,使用new关键字和Thread类或其子类建立一个线程对象后,该线程对象就处于新建状态,他保持这个状态知道程序start()这个线程</li>
<li>就绪状态:Runnable当线程对象调用了<code>start()</code>方法后.该线程就进入就绪状态,就绪状态的线程处于就绪队列中.要等待JVM里线程调度的调度</li>
<li>Running 如果就绪状态的线程获取CPU资源,局可以执行<code>run()</code>,此时线程便处于运行状态,处于运行状态的线程最为复杂,他可以变为阻塞状态,就绪状态和死亡状态</li>
<li>阻塞状态:Blocked 如果线程执行了<code>sleep(睡眠)</code>,<code>suspend(挂起)</code>等方法,失去占用资源之后.该线程就从运行状态.进入阻塞状态,在睡眠已到获得设备资源后可以重新进入就绪状态,可以分为三种:<ol>
<li>等待阻塞:运行状态中的线程执行<code>wait()</code>方法.使线程进入到等待阻塞状态</li>
<li>同步阻塞:线程在获取<code>synchronized</code>同步锁失败(因为同步锁被其他线程占用)</li>
<li>其他阻塞:通过调用线程的<code>sleep()</code>或<code>join()</code>发出I/O请求时,线程就会进入到阻塞状态,当<code>sleep()</code>状态超时,<code>join()</code>等待线程终止或超时,或者I/O处理完毕,线程重新转入就绪状态</li>
</ol>
</li>
<li>死亡状态:Dead,一个运行状态的线程,完成任务或者其他终止条件发生时,该线程就切换到终止状态</li>
</ol>
<h2 id="2-多线程实现方式"><a href="#2-多线程实现方式" class="headerlink" title="2.多线程实现方式"></a>2.多线程实现方式</h2><p>Java 提供了三种创建线程的方法：</p>
<ul>
<li>通过继承 Thread 类本身。</li>
<li>通过实现 Runnable 接口。</li>
<li>通过 Callable 和 Future 创建线程。</li>
</ul>
<h3 id="2-1继承Thread"><a href="#2-1继承Thread" class="headerlink" title="2.1继承Thread"></a>2.1继承Thread</h3><p>创建一个线程的第一种方法是创建一个类并继承Thread类,然后创建该类的实例,继承类必须重写run()方法,该方法是新线程的入口点,他也必须调用start()方法才能执行.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        System.out.println(<span class="string">&quot;创建线程: &quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;创建线程:&quot;</span> + name + i);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\n退出线程: &quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> MyThread(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> MyThread(<span class="string">&quot;B&quot;</span>);</span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-2实现Runnable"><a href="#2-2实现Runnable" class="headerlink" title="2.2实现Runnable"></a>2.2实现Runnable</h3><p>创建一个线程的第二种方法是创建一个实现Runnable接口的类.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyRunnable</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;创建线程: &quot;</span>+name+<span class="string">&quot; &quot;</span>+i);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> MyRunnable(<span class="string">&quot;ThreadA&quot;</span>));</span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> MyRunnable(<span class="string">&quot;ThreadB&quot;</span>));</span><br><span class="line"></span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-3通过Callable和Future创建线程"><a href="#2-3通过Callable和Future创建线程" class="headerlink" title="2.3通过Callable和Future创建线程"></a>2.3通过Callable和Future创建线程</h3><p>第三种方法是通过<code>Callable</code>和<code>Future</code>创建线程,前面两种都是无返回值,而这种方法适合获取线程的执行结构,基本步骤如下:</p>
<ol>
<li>创建<code>Callable</code>接口的实现类,并实现<code>call()</code>方法,该<code>call()</code>方法将作为线程执行体,并且有返回值</li>
<li>创建<code>Callable</code>实现类的实例,使用<code>FutureTask</code>类来包装Callable对象,该<code>FutureTask</code>对象封装了该 <code>Callable</code>对象的<code>call()</code>方法的返回值</li>
<li>使用<code>FutureTask</code>对象作为Thread对象的<code>target</code>创建并启动新线程</li>
<li>调用<code>FutureTask</code>对象的get()方法来获得子线程执行结束后的返回值</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCallable</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; &quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        MyCallable myCallable = <span class="keyword">new</span> MyCallable();</span><br><span class="line">        FutureTask&lt;Integer&gt; ft = <span class="keyword">new</span> FutureTask&lt;&gt;(myCallable);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(ft, <span class="string">&quot;有返回值的线程&quot;</span>).start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;子线程的返回值：&quot;</span> + ft.get());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="线程的控制-常见方法"><a href="#线程的控制-常见方法" class="headerlink" title="线程的控制(常见方法)"></a>线程的控制(常见方法)</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/19/java8-Stream%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="冯玮">
      <meta itemprop="description" content="以梦为马，明日天涯">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冯玮的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/19/java8-Stream%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">java8 Stream学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-19 15:27:24 / 修改时间：15:27:48" itemprop="dateCreated datePublished" datetime="2020-11-19T15:27:24+08:00">2020-11-19</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="JDK8-–-Stream"><a href="#JDK8-–-Stream" class="headerlink" title="JDK8 – Stream"></a>JDK8 – Stream</h1><p><img src="https://img-blog.csdnimg.cn/2020110911333574.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L211X3dpbmQ=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2 id="Stream能做什么"><a href="#Stream能做什么" class="headerlink" title="Stream能做什么?"></a>Stream能做什么?</h2><p>先贴上几个案例:</p>
<ol>
<li>从员工集合中筛选中salary大于8000的员工,并放置到新的集合里</li>
<li>统计员工的最高薪资,平均薪资,薪资之和</li>
<li>将员工按薪资从高到低排序,同样薪资者年龄小者在前</li>
<li>将员工按性别分类,将员工按性别和地区分类,将员工按薪资是否高于8000分为两部分</li>
</ol>
<p>用传统的遍历也是不难,但是需要大量的代码,跟stream相比高下立判</p>
<h2 id="1-stream概述"><a href="#1-stream概述" class="headerlink" title="1.stream概述"></a>1.stream概述</h2><p>java8 是一个非常成功的版本,这个版本新增的Stream,配合同版本出现的Lambda.给我们操作集合(Collection)提供了极大的遍历</p>
<p>那么什么是<code>Stream</code>?</p>
<blockquote>
<p><code>Stream</code>将要处理元素的集合看做一种流,再流的过程中,借助<code>Stream Api</code>对流中的元素进行操作,比如:筛选,排序,聚合等.</p>
</blockquote>
<p><code>Stream</code>可以由数组或集合创建,对流的操作分为两种</p>
<ol>
<li>中间操作,每次返回一个新的流,,可以有多个</li>
<li>终端操作,每个流只能进行一次终端操作,终端操作结束后流无法再次使用,终端操作会产生一个新的集合或值.</li>
</ol>
<p>另外,<code>stream</code>有几个特性:</p>
<ol>
<li><code>stream</code>不存储数据,而是按照特定的规则对数据进行计算,一般会输出结构</li>
<li><code>stream</code>不会改变数据源,通常情况下不会产生一个新的集合或一个值</li>
<li><code>stream</code>具有延迟执行特性,只有调用终端操作时,中间操作才会执行</li>
</ol>
<h2 id="2-stream-的创建"><a href="#2-stream-的创建" class="headerlink" title="2.stream 的创建"></a>2.stream 的创建</h2><p><code>stream</code>可以通过集合数据创建</p>
<ol>
<li><p>通过<code>java.unil.Collection.stream()</code>方法用集合创建流</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = Arrays.asList(<span class="string">&quot;str1&quot;</span>, <span class="string">&quot;str2&quot;</span>, <span class="string">&quot;str3&quot;</span>);</span><br><span class="line"><span class="comment">//创建顺序流</span></span><br><span class="line">Stream&lt;String&gt; stream = list.stream();</span><br><span class="line"><span class="comment">//创建并行流</span></span><br><span class="line">Stream&lt;String&gt; stringStream = list.parallelStream();</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p>使用<code>java.unil.Arrays.stream(T[] array)</code>方法用数组创建流</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span>[] array = &#123;<span class="number">12</span>, <span class="number">23</span>, <span class="number">12</span>, <span class="number">44</span>&#125;;</span><br><span class="line">IntStream arrayStream = Arrays.stream(array);</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="3">
<li><p>使用<code>Stream</code>的静态方法:<code>of(),iterate(),generate()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Stream&lt;Integer&gt; integerStream = Stream.of(<span class="number">1</span>, <span class="number">23</span>, <span class="number">4</span>);</span><br><span class="line">Stream&lt;Integer&gt; limit = Stream.iterate(<span class="number">1</span>, x -&gt; x + <span class="number">4</span>).limit(<span class="number">10</span>);</span><br><span class="line">Stream&lt;Double&gt; doubleStream = Stream.generate(Math::random).limit(<span class="number">10</span>);</span><br><span class="line">doubleStream.forEach(System.out::println);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><code>stream</code>和<code>parallelStream</code>的简单区分:<code>stream</code>是顺序流,由主线程按顺序对流进行执行操作,而<code>parallelStream</code> 是并行流,内部以多线程并行执行的方式对流进行操作,但前提是流中的数据处理没有顺序要求,例如筛选集合中的奇数,两者的处理不同之处:</p>
<p><img src="https://img-blog.csdnimg.cn/20201106164400889.png" alt="在这里插入图片描述"></p>
<p>如果流中的数据量足够大,并行流通过<code>parallel()</code>把顺序转换成并行流:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Optional&lt;Integer&gt; findFirst = list.stream().parallel().filter(x-&gt;x&gt;<span class="number">6</span>).findFirst();</span><br></pre></td></tr></table></figure>

<h2 id="3-stream-的使用"><a href="#3-stream-的使用" class="headerlink" title="3.stream 的使用"></a>3.stream 的使用</h2><p>在使用<code>stream</code>之前.先理解一个概念:<code>Optional</code></p>
<blockquote>
<p><code>Optional</code>类是一个可以<code>null</code>的容器对象,如果存在则<code>isPresent()</code>方法返回<code>true</code>,调用<code>get()</code>方法会返回该对象</p>
</blockquote>
<p>案例中使用的员工类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Persion</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Integer salary;</span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line">    <span class="keyword">private</span> String area;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Persion</span><span class="params">(String name, Integer age, Integer salary, String gender, String area)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.salary = salary;</span><br><span class="line">        <span class="keyword">this</span>.gender = gender;</span><br><span class="line">        <span class="keyword">this</span>.area = area;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//省略get() set()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初始化员工</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Persion&gt; persions = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;张三&quot;</span>,<span class="number">26</span>,<span class="number">8000</span>,<span class="string">&quot;男&quot;</span>,<span class="string">&quot;广州&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;李四&quot;</span>,<span class="number">23</span>,<span class="number">7600</span>,<span class="string">&quot;女&quot;</span>,<span class="string">&quot;天津&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;王五&quot;</span>,<span class="number">43</span>,<span class="number">8409</span>,<span class="string">&quot;男&quot;</span>,<span class="string">&quot;北京&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;赵六&quot;</span>,<span class="number">26</span>,<span class="number">9872</span>,<span class="string">&quot;女&quot;</span>,<span class="string">&quot;上海&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;周八&quot;</span>,<span class="number">34</span>,<span class="number">6504</span>,<span class="string">&quot;男&quot;</span>,<span class="string">&quot;广州&quot;</span>));</span><br></pre></td></tr></table></figure>

<h3 id="3-1-遍历-匹配-foreach-find-match"><a href="#3-1-遍历-匹配-foreach-find-match" class="headerlink" title="3.1 遍历/匹配(foreach/find.match)"></a>3.1 遍历/匹配(foreach/find.match)</h3><p><code>stream</code>也是支持类似集合的遍历和匹配元素的,只是<code>Stream</code>中的元素是以<code>Optional</code>类型存在的</p>
<p><code>Stream</code>的遍历和匹配是非常简单的</p>
<p><img src="https://img-blog.csdnimg.cn/2020110914450139.png" alt="在这里插入图片描述"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>);</span><br><span class="line">Stream&lt;Integer&gt; integerStream = list.stream().filter(x -&gt; x &gt; <span class="number">10</span>);</span><br><span class="line"><span class="comment">//遍历出所有符合条件的元素</span></span><br><span class="line">integerStream.forEach(System.out::println);</span><br><span class="line"><span class="comment">//匹配第一个筛选出来的元素</span></span><br><span class="line">Optional&lt;Integer&gt; first = list.stream().filter(x -&gt; x &gt; <span class="number">6</span>).findFirst();</span><br><span class="line">System.out.println(first);</span><br><span class="line"><span class="comment">//筛选出任意一个符合条件的元素</span></span><br><span class="line">Optional&lt;Integer&gt; any = list.stream().parallel().filter(x -&gt; x &gt; <span class="number">6</span>).findAny();</span><br><span class="line">System.out.println(any);</span><br><span class="line"><span class="comment">//是否包含特定条件的元素</span></span><br><span class="line"><span class="keyword">boolean</span> match = list.stream().anyMatch(x -&gt; x &lt; <span class="number">6</span>);</span><br><span class="line">System.out.println(match);</span><br><span class="line"><span class="comment">//是否所有的元素都符合条件</span></span><br><span class="line"><span class="keyword">boolean</span> b = list.stream().allMatch(x -&gt; x &lt; <span class="number">10</span>);</span><br><span class="line">System.out.println(b);</span><br></pre></td></tr></table></figure>



<h3 id="3-2-筛选-filter"><a href="#3-2-筛选-filter" class="headerlink" title="3.2 筛选(filter)"></a>3.2 筛选(filter)</h3><p>筛选,是按照一定的规则校验流中的元素,将符合条件的元素提取到新的流中的操作.</p>
<p><img src="https://img-blog.csdnimg.cn/20201109144706541.jpg" alt="stream的筛选"></p>
<p><strong>案例:筛选出<code>Integer</code>集合中大于7的元素,并打印出来</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>);</span><br><span class="line">list.stream().filter(n -&gt; n &gt; <span class="number">7</span>).forEach(System.out::println);</span><br></pre></td></tr></table></figure>

<p><strong>案例:筛选员工中工资高于8000的人,并形成新的集合</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Persion&gt; persions = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;张三&quot;</span>,<span class="number">26</span>,<span class="number">8000</span>,<span class="string">&quot;男&quot;</span>,<span class="string">&quot;广州&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;李四&quot;</span>,<span class="number">23</span>,<span class="number">7600</span>,<span class="string">&quot;女&quot;</span>,<span class="string">&quot;天津&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;王五&quot;</span>,<span class="number">43</span>,<span class="number">8409</span>,<span class="string">&quot;男&quot;</span>,<span class="string">&quot;北京&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;赵六&quot;</span>,<span class="number">26</span>,<span class="number">9872</span>,<span class="string">&quot;女&quot;</span>,<span class="string">&quot;上海&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;周八&quot;</span>,<span class="number">34</span>,<span class="number">6504</span>,<span class="string">&quot;男&quot;</span>,<span class="string">&quot;广州&quot;</span>));</span><br><span class="line">List&lt;Persion&gt; list1 = persions.stream().filter(persion -&gt; persion.getSalary() &gt; <span class="number">8000</span>).collect(Collectors.toList());</span><br><span class="line">System.out.println(list1);</span><br></pre></td></tr></table></figure>



<h3 id="3-3聚合-max-min-count"><a href="#3-3聚合-max-min-count" class="headerlink" title="3.3聚合(max/min/count)"></a>3.3聚合(max/min/count)</h3><p><code>max</code>,<code>min</code>,<code>count</code>这些词在sql中经常使用,现在stream中也 引入了这些概念和用法,极大的程度方便了我们对集合.数组的统计工作</p>
<p><img src="D:\工作学习\设计模式图片\steam聚合.png" alt="在这里插入图片描述"></p>
<p><strong>案例:获取<code>String</code>集合中最长的元素</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; stringList = Arrays.asList(<span class="string">&quot;java&quot;</span>, <span class="string">&quot;net&quot;</span>, <span class="string">&quot;c#&quot;</span>, <span class="string">&quot;python&quot;</span>, <span class="string">&quot;php&quot;</span>);</span><br><span class="line"><span class="comment">//输入最长的字符串</span></span><br><span class="line">Optional&lt;String&gt; max1 = stringList.stream().max(Comparator.comparing(String::length));</span><br><span class="line">System.out.println(max1);<span class="comment">//输出结果  python</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//输出最短的字符串</span></span><br><span class="line">Optional&lt;String&gt; max = stringList.stream().max(<span class="keyword">new</span> Comparator&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(String o1, String o2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> o2.length() - o1.length(); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">System.out.println(max);<span class="comment">//输出 c#</span></span><br></pre></td></tr></table></figure>

<p><strong>案例:获取<code>Integer</code>集合中的最大值</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; integerList = Arrays.asList(<span class="number">100</span>, <span class="number">200</span>, <span class="number">120</span>, <span class="number">110</span>, <span class="number">99</span>, <span class="number">89</span>);</span><br><span class="line">Optional&lt;Integer&gt; max = integerList.stream().max(Integer::compareTo);</span><br><span class="line">System.out.println(max);</span><br><span class="line"><span class="comment">//自定义比较</span></span><br><span class="line">Optional&lt;Integer&gt; max1 = integerList.stream().max(<span class="keyword">new</span> Comparator&lt;Integer&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Integer o1, Integer o2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> o1.compareTo(o2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>案例:获取员工工资最高的人</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Persion&gt; persions = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;张三&quot;</span>, <span class="number">26</span>, <span class="number">8000</span>, <span class="string">&quot;男&quot;</span>, <span class="string">&quot;广州&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;李四&quot;</span>, <span class="number">23</span>, <span class="number">7600</span>, <span class="string">&quot;女&quot;</span>, <span class="string">&quot;天津&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;王五&quot;</span>, <span class="number">43</span>, <span class="number">8409</span>, <span class="string">&quot;男&quot;</span>, <span class="string">&quot;北京&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;赵六&quot;</span>, <span class="number">26</span>, <span class="number">9872</span>, <span class="string">&quot;女&quot;</span>, <span class="string">&quot;上海&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;周八&quot;</span>, <span class="number">34</span>, <span class="number">6504</span>, <span class="string">&quot;男&quot;</span>, <span class="string">&quot;广州&quot;</span>));</span><br><span class="line">Optional&lt;Persion&gt; max2 =  persions.stream().max(Comparator.comparingInt(Persion::getSalary));</span><br><span class="line">System.out.println(max2);</span><br></pre></td></tr></table></figure>

<p><strong>案例:计算<code>Integer</code>集合中大于6的元素个数</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; integerList = Arrays.asList(<span class="number">100</span>, <span class="number">200</span>, <span class="number">120</span>, <span class="number">110</span>, <span class="number">99</span>, <span class="number">89</span>);</span><br><span class="line"><span class="keyword">long</span> count = integerList.stream().filter(n -&gt; n &gt; <span class="number">6</span>).count();</span><br><span class="line">System.out.println(<span class="string">&quot;count=&quot;</span>+count);</span><br></pre></td></tr></table></figure>



<h3 id="3-4映射-map-flatMap"><a href="#3-4映射-map-flatMap" class="headerlink" title="3.4映射(map/flatMap)"></a>3.4映射(map/flatMap)</h3><p>映射,可以将一个流的元素按照一定的映射规则映射到另一个流中,分别为<code>map</code>,<code>flatMap</code></p>
<ul>
<li><code>map</code>:接受一个函数作为参数,该函数会被应用到每个元素上,并将其英社称一个新的元素</li>
<li><code>flatMap</code>:接收一个函数作为参数,将流中的每一个值都换成另一个流,然后把所有的流连接成一个流</li>
</ul>
<p><img src="D:\工作学习\设计模式图片\stream-map图解.jpg" alt="在这里插入图片描述"></p>
<p><img src="D:\工作学习\设计模式图片\stream-flatmap图解.jpg" alt="在这里插入图片描述"></p>
<p><strong>案例:英文字符串数组的元素全部改为大写,整个数组的每个元素+3</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; stringList = Arrays.asList(<span class="string">&quot;java&quot;</span>, <span class="string">&quot;net&quot;</span>, <span class="string">&quot;c++&quot;</span>, <span class="string">&quot;python&quot;</span>, <span class="string">&quot;php&quot;</span>);</span><br><span class="line"><span class="comment">//首字母大写</span></span><br><span class="line">List&lt;String&gt; collect = stringList.stream().map(str -&gt; str.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase() + str.substring(<span class="number">1</span>)).collect(Collectors.toList());</span><br><span class="line">System.out.println(collect);</span><br><span class="line">List&lt;Integer&gt; integerList = Arrays.asList(<span class="number">100</span>, <span class="number">200</span>, <span class="number">120</span>, <span class="number">110</span>, <span class="number">99</span>, <span class="number">89</span>);</span><br><span class="line"><span class="comment">//每个元素+3</span></span><br><span class="line">List&lt;Integer&gt; collect1 = integerList.stream().map(n -&gt; n + <span class="number">3</span>).collect(Collectors.toList());</span><br><span class="line">System.out.println(collect1);</span><br></pre></td></tr></table></figure>

<p><strong>将两个字符串组合合并成一个新的字符串数组</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; stringList = Arrays.asList(<span class="string">&quot;1,2,4,5&quot;</span>, <span class="string">&quot;ab,cd,ef&quot;</span>);</span><br><span class="line">List&lt;String&gt; collect = stringList.stream().flatMap(str -&gt; &#123;</span><br><span class="line">    String[] split = str.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">    Stream&lt;String&gt; split1 = Stream.of(split);</span><br><span class="line">    <span class="keyword">return</span> split1;</span><br><span class="line">&#125;).collect(Collectors.toList());</span><br><span class="line">System.out.println(stringList);</span><br><span class="line">System.out.println(collect);</span><br></pre></td></tr></table></figure>



<h3 id="3-5归约-reduce"><a href="#3-5归约-reduce" class="headerlink" title="3.5归约(reduce)"></a>3.5归约(reduce)</h3><p>规约,也成缩减,顾名思义,是把一个流缩减成一个值,能实现对集合求和,求乘机和最值的操作</p>
<p><strong>案例一：求<code>Integer</code>集合的元素之和、乘积和最大值</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; integerList = Arrays.asList(<span class="number">2</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">56</span>, <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line"><span class="comment">//求和</span></span><br><span class="line">Optional&lt;Integer&gt; sum = integerList.stream().reduce((x, y) -&gt; x + y);<span class="comment">//多个参数需要在箭头的左边加(括号)</span></span><br><span class="line">System.out.println(sum);</span><br><span class="line">Integer sum1 = integerList.stream().reduce(<span class="number">0</span>, Integer::sum);</span><br><span class="line">System.out.println(sum1);</span><br><span class="line">Optional&lt;Integer&gt; sum2 = integerList.stream().reduce(Integer::sum);</span><br><span class="line">System.out.println(sum2);</span><br><span class="line"><span class="comment">//求乘积</span></span><br><span class="line">Optional&lt;Integer&gt; d = integerList.stream().reduce((x, y) -&gt; x * y);</span><br><span class="line">System.out.println(d);</span><br><span class="line"><span class="comment">//求最大值</span></span><br><span class="line">Optional&lt;Integer&gt; max1 = integerList.stream().reduce((x, y) -&gt; x &gt; y ? x : y);</span><br><span class="line">System.out.println(max1);</span><br><span class="line">Optional&lt;Integer&gt; max2 = integerList.stream().reduce(Integer::max);</span><br><span class="line">System.out.println(max2);</span><br></pre></td></tr></table></figure>

<p><strong>案例二：求所有员工的工资之和和最高工资</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Persion&gt; persions = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;张三&quot;</span>, <span class="number">26</span>, <span class="number">8000</span>, <span class="string">&quot;男&quot;</span>, <span class="string">&quot;广州&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;李四&quot;</span>, <span class="number">23</span>, <span class="number">7600</span>, <span class="string">&quot;女&quot;</span>, <span class="string">&quot;天津&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;王五&quot;</span>, <span class="number">43</span>, <span class="number">8409</span>, <span class="string">&quot;男&quot;</span>, <span class="string">&quot;北京&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;赵六&quot;</span>, <span class="number">26</span>, <span class="number">9872</span>, <span class="string">&quot;女&quot;</span>, <span class="string">&quot;上海&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;周八&quot;</span>, <span class="number">34</span>, <span class="number">6504</span>, <span class="string">&quot;男&quot;</span>, <span class="string">&quot;广州&quot;</span>));</span><br><span class="line"><span class="comment">//获取所有的工资</span></span><br><span class="line">List&lt;Integer&gt; salary = persions.stream().map(persion -&gt; persion.getSalary()).collect(Collectors.toList());</span><br><span class="line"><span class="comment">//工资之和</span></span><br><span class="line">Optional&lt;Integer&gt; sum1 = salary.stream().reduce((x, y) -&gt; x + y);</span><br><span class="line">System.out.println(sum1);</span><br><span class="line">Integer sum2 = persions.stream().reduce(<span class="number">0</span>, (sum, p) -&gt; sum = sum + p.getSalary(), (x, y) -&gt; x + y);</span><br><span class="line">System.out.println(sum2);</span><br><span class="line">Integer sum3 = persions.stream().reduce(<span class="number">0</span>, (sum, p) -&gt; sum + p.getSalary(), Integer::sum);</span><br><span class="line">System.out.println(sum3);</span><br><span class="line"><span class="comment">//求最高工资</span></span><br><span class="line">Integer max1 = persions.stream().reduce(<span class="number">0</span>, (max, p) -&gt; max &gt; p.getSalary() ? max : p.getSalary(), Integer::max);</span><br><span class="line">System.out.println(max1);</span><br><span class="line">Integer max2 = persions.stream().reduce(<span class="number">0</span>, (max, p) -&gt; max &gt; p.getSalary() ? max : p.getSalary(), (x, y) -&gt; x &gt; y ? x : y);</span><br><span class="line">System.out.println(max2);</span><br></pre></td></tr></table></figure>

<h3 id="3-6收集-collect"><a href="#3-6收集-collect" class="headerlink" title="3.6收集(collect)"></a>3.6收集(collect)</h3><p><code>collect</code> ,收集,可以说是内容繁多,功能最丰富的部分了,从字面上理解,就是把一个流收集起来,最终可以收集成一个值也可以手机恒一个新的集合.</p>
<blockquote>
<p><code>collect</code>主要依赖<code>java.unil.stream.Collectors</code>类内置的静态方法.</p>
</blockquote>
<h4 id="3-6-1归集-toSet-toList-toMap"><a href="#3-6-1归集-toSet-toList-toMap" class="headerlink" title="3.6.1归集(toSet,toList,toMap)"></a>3.6.1归集(toSet,toList,toMap)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Persion&gt; persions = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;张三&quot;</span>, <span class="number">26</span>, <span class="number">8000</span>, <span class="string">&quot;男&quot;</span>, <span class="string">&quot;广州&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;李四&quot;</span>, <span class="number">23</span>, <span class="number">7600</span>, <span class="string">&quot;女&quot;</span>, <span class="string">&quot;天津&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;王五&quot;</span>, <span class="number">43</span>, <span class="number">8409</span>, <span class="string">&quot;男&quot;</span>, <span class="string">&quot;北京&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;赵六&quot;</span>, <span class="number">26</span>, <span class="number">9872</span>, <span class="string">&quot;女&quot;</span>, <span class="string">&quot;上海&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;周八&quot;</span>, <span class="number">34</span>, <span class="number">6504</span>, <span class="string">&quot;男&quot;</span>, <span class="string">&quot;广州&quot;</span>));</span><br><span class="line"><span class="comment">//获取所有的工资</span></span><br><span class="line">Set&lt;Integer&gt; salary = persions.stream().map(persion -&gt; persion.getSalary()).collect(Collectors.toSet());</span><br><span class="line"><span class="comment">//toMap</span></span><br><span class="line">Map&lt;Integer, String&gt; collect = persions.stream()</span><br><span class="line">        .filter(p -&gt; p.getSalary() &gt; <span class="number">8000</span>)</span><br><span class="line">        .collect(Collectors.toMap(Persion::getSalary,Persion::getName));</span><br><span class="line">System.out.println(collect);<span class="comment">//结果:&#123;9872=赵六, 8409=王五&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-6-2统计-count-averaging"><a href="#3-6-2统计-count-averaging" class="headerlink" title="3.6.2统计(count/averaging)"></a>3.6.2统计(count/averaging)</h4><p><code>Collectors</code>提供了一些列用于数据统计的静态方法;</p>
<ul>
<li>计数:<code>count</code></li>
<li>平均值:<code>averagingInt</code>,<code>averagingLong</code>,<code>averagingDouble</code></li>
<li>最值:<code>maxBy</code>,<code>minBy</code></li>
<li>求和:<code>summingInt</code>,<code>summingLong</code>,<code>summingDouble</code></li>
<li>统计以上所有:<code>summarizingInt</code>,<code>summarizingLong</code>,<code>summarizingDouble</code></li>
</ul>
<p><strong>案例:统计所有员工人数,平均工资,工资总额,最高工资</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Persion&gt; persions = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;张三&quot;</span>, <span class="number">26</span>, <span class="number">8000</span>, <span class="string">&quot;男&quot;</span>, <span class="string">&quot;广州&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;李四&quot;</span>, <span class="number">23</span>, <span class="number">7600</span>, <span class="string">&quot;女&quot;</span>, <span class="string">&quot;天津&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;王五&quot;</span>, <span class="number">43</span>, <span class="number">8409</span>, <span class="string">&quot;男&quot;</span>, <span class="string">&quot;北京&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;赵六&quot;</span>, <span class="number">26</span>, <span class="number">9872</span>, <span class="string">&quot;女&quot;</span>, <span class="string">&quot;上海&quot;</span>));</span><br><span class="line">persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;周八&quot;</span>, <span class="number">34</span>, <span class="number">6504</span>, <span class="string">&quot;男&quot;</span>, <span class="string">&quot;广州&quot;</span>));</span><br><span class="line"><span class="comment">//员工人数</span></span><br><span class="line"><span class="keyword">long</span> count = persions.stream().count();</span><br><span class="line">System.out.println(<span class="string">&quot;员工人数: &quot;</span> + count);</span><br><span class="line"><span class="comment">//平均工资</span></span><br><span class="line">Double collect = persions.stream().collect(Collectors.averagingDouble(Persion::getSalary));</span><br><span class="line">System.out.println(<span class="string">&quot;平均工资: &quot;</span>+collect);</span><br><span class="line"><span class="comment">//最高工资</span></span><br><span class="line">Optional&lt;Integer&gt; max = persions.stream().map(persion -&gt; persion.getSalary()).max(Integer::compareTo);</span><br><span class="line">System.out.println(<span class="string">&quot;最高工资: &quot;</span>+max.get());</span><br><span class="line"><span class="comment">//工资之和</span></span><br><span class="line">Integer collect1 = persions.stream().collect(Collectors.summingInt(Persion::getSalary));</span><br><span class="line">System.out.println(<span class="string">&quot;工资之和: &quot;</span>+collect1);</span><br><span class="line"><span class="comment">//一次性统计所有信息</span></span><br><span class="line">DoubleSummaryStatistics collect2 = persions.stream().collect(Collectors.summarizingDouble(Persion::getSalary));</span><br><span class="line">System.out.println(<span class="string">&quot;一次性统计所有信息: &quot;</span>+collect2);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">员工人数: <span class="number">5</span></span><br><span class="line">平均工资: <span class="number">8077.0</span></span><br><span class="line">最高工资: <span class="number">9872</span></span><br><span class="line">工资之和: <span class="number">40385</span></span><br><span class="line">一次性统计所有信息: DoubleSummaryStatistics&#123;count=<span class="number">5</span>, sum=<span class="number">40385.000000</span>, min=<span class="number">6504.000000</span>, average=<span class="number">8077.000000</span>, max=<span class="number">9872.000000</span>&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-6-3分组-groupingBy"><a href="#3-6-3分组-groupingBy" class="headerlink" title="3.6.3分组(groupingBy)"></a>3.6.3分组(groupingBy)</h4><ul>
<li>分区:将<code>stream</code>按条件分为两个<code>map</code>,比如员工按薪资是否高于8000分为两个部分</li>
<li>分组:将集合分为多个<code>Map</code>,比如员工按性别分组,有单级分组和多级分组</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20201109145807450.png#pic_left" alt="在这里插入图片描述"></p>
<p><strong>案例:将员工按薪资是否高于8000分为两个部分;将员工按性别和地区分组</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将员工按照薪资8000进行分组</span></span><br><span class="line">Map&lt;Boolean, List&lt;Persion&gt;&gt; collect = persions.stream().collect(Collectors.partitioningBy(persion -&gt; persion.getSalary() &gt; <span class="number">8000</span>));</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//结果输出</span></span><br><span class="line">&#123;<span class="keyword">false</span>=[Persion&#123;name=<span class="string">&#x27;张三&#x27;</span>, age=<span class="number">26</span>, salary=<span class="number">8000</span>, gender=<span class="string">&#x27;男&#x27;</span>, area=<span class="string">&#x27;广州&#x27;</span>&#125;, Persion&#123;name=<span class="string">&#x27;李四&#x27;</span>, age=<span class="number">23</span>, salary=<span class="number">7600</span>, gender=<span class="string">&#x27;女&#x27;</span>, area=<span class="string">&#x27;天津&#x27;</span>&#125;, Persion&#123;name=<span class="string">&#x27;周八&#x27;</span>, age=<span class="number">34</span>, salary=<span class="number">6504</span>, gender=<span class="string">&#x27;男&#x27;</span>, area=<span class="string">&#x27;广州&#x27;</span>&#125;], </span><br><span class="line"> <span class="keyword">true</span>=[Persion&#123;name=<span class="string">&#x27;王五&#x27;</span>, age=<span class="number">43</span>, salary=<span class="number">8409</span>, gender=<span class="string">&#x27;男&#x27;</span>, area=<span class="string">&#x27;北京&#x27;</span>&#125;, Persion&#123;name=<span class="string">&#x27;赵六&#x27;</span>, age=<span class="number">26</span>, salary=<span class="number">9872</span>, gender=<span class="string">&#x27;女&#x27;</span>, area=<span class="string">&#x27;上海&#x27;</span>&#125;]&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//按照员工的性别和地区进行分组</span></span><br><span class="line">Map&lt;String, Map&lt;String, List&lt;Persion&gt;&gt;&gt; collect1 = persions.stream().collect(Collectors.groupingBy(persion -&gt; persion.getGender(),</span><br><span class="line">        Collectors.groupingBy(persion-&gt;persion.getArea())));</span><br><span class="line">System.out.println(collect1);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//结果输出</span></span><br><span class="line">&#123;女=&#123;上海=[Persion&#123;name=<span class="string">&#x27;赵六&#x27;</span>, age=<span class="number">26</span>, salary=<span class="number">9872</span>, gender=<span class="string">&#x27;女&#x27;</span>, area=<span class="string">&#x27;上海&#x27;</span>&#125;], 天津=[Persion&#123;name=<span class="string">&#x27;李四&#x27;</span>, age=<span class="number">23</span>, salary=<span class="number">7600</span>, gender=<span class="string">&#x27;女&#x27;</span>, area=<span class="string">&#x27;天津&#x27;</span>&#125;]&#125;, 男=&#123;广州=[Persion&#123;name=<span class="string">&#x27;张三&#x27;</span>, age=<span class="number">26</span>, salary=<span class="number">8000</span>, gender=<span class="string">&#x27;男&#x27;</span>, area=<span class="string">&#x27;广州&#x27;</span>&#125;, Persion&#123;name=<span class="string">&#x27;周八&#x27;</span>, age=<span class="number">34</span>, salary=<span class="number">6504</span>, gender=<span class="string">&#x27;男&#x27;</span>, area=<span class="string">&#x27;广州&#x27;</span>&#125;], 北京=[Persion&#123;name=<span class="string">&#x27;王五&#x27;</span>, age=<span class="number">43</span>, salary=<span class="number">8409</span>, gender=<span class="string">&#x27;男&#x27;</span>, area=<span class="string">&#x27;北京&#x27;</span>&#125;]&#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3-6-4接合-joining"><a href="#3-6-4接合-joining" class="headerlink" title="3.6.4接合(joining)"></a>3.6.4接合(joining)</h4><p><code>joining</code>可以将<code>stream</code>中元素用特定的连接符(没有的话,则直接连接)连接成一个字符串</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//将员工的名字连接成一个字符串</span></span><br><span class="line"> List&lt;String&gt; names = persions.stream().map(persion -&gt;  persion.getName()).collect(Collectors.toList());</span><br><span class="line"> String nameStr = names.stream().collect(Collectors.joining(<span class="string">&quot;-&quot;</span>));</span><br><span class="line"> System.out.println(nameStr);</span><br><span class="line"><span class="comment">//打印结果: 张三-李四-王五-赵六-周八</span></span><br></pre></td></tr></table></figure>



<h4 id="3-6-5归约-reducing"><a href="#3-6-5归约-reducing" class="headerlink" title="3.6.5归约(reducing)"></a>3.6.5归约(reducing)</h4><p><code>Collectors</code>类提供的<code>reducing</code>方法,相比于<code>stream</code>本身的<code>reduce</code>方法,增加了对自定义归约的支持.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Integer sum = persions.stream().collect(Collectors.reducing(<span class="number">0</span>, Persion::getSalary, Integer::sum));</span><br><span class="line">System.out.println(sum);</span><br><span class="line"><span class="comment">//stream的reduce</span></span><br><span class="line">Integer sum = persions.stream().map(Persion::getSalary).reduce(<span class="number">0</span>, Integer::sum);</span><br><span class="line"></span><br><span class="line">BigDecimal reduce = bigDecimals.stream().reduce(BigDecimal.ZERO, BigDecimal::add);</span><br><span class="line">System.out.println(reduce);</span><br></pre></td></tr></table></figure>



<h3 id="3-7排序-sorted"><a href="#3-7排序-sorted" class="headerlink" title="3.7排序(sorted)"></a>3.7排序(sorted)</h3><p><code>sorted</code>中间操作,有两种排序:</p>
<ul>
<li><code>sorted()</code>:自然排序,流中元素需实现<code>Comparable</code>接口</li>
<li><code>sorted(Comparator com)</code>:<code>Compatator</code>自定义排序</li>
</ul>
<p><strong>案例:将员工工资由高到低(工资一样则按年龄有大到小排序)</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> List&lt;Persion&gt; persions = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"> persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;张三&quot;</span>, <span class="number">26</span>, <span class="number">8000</span>, <span class="string">&quot;男&quot;</span>, <span class="string">&quot;广州&quot;</span>));</span><br><span class="line"> persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;李四&quot;</span>, <span class="number">23</span>, <span class="number">7600</span>, <span class="string">&quot;女&quot;</span>, <span class="string">&quot;天津&quot;</span>));</span><br><span class="line"> persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;王五&quot;</span>, <span class="number">43</span>, <span class="number">8409</span>, <span class="string">&quot;男&quot;</span>, <span class="string">&quot;北京&quot;</span>));</span><br><span class="line"> persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;赵六&quot;</span>, <span class="number">40</span>, <span class="number">8000</span>, <span class="string">&quot;女&quot;</span>, <span class="string">&quot;上海&quot;</span>));</span><br><span class="line"> persions.add(<span class="keyword">new</span> Persion(<span class="string">&quot;周八&quot;</span>, <span class="number">34</span>, <span class="number">6504</span>, <span class="string">&quot;男&quot;</span>, <span class="string">&quot;广州&quot;</span>));</span><br><span class="line"><span class="comment">//将员工按照薪水高低进行排序(薪资一样,按照年龄排)</span></span><br><span class="line">List&lt;Persion&gt; collect = persions.stream().sorted(Comparator.comparingInt(Persion::getSalary).thenComparing(Persion::getAge)).collect(Collectors.toList());</span><br><span class="line">System.out.println(collect);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[Persion&#123;name=<span class="string">&#x27;周八&#x27;</span>, age=<span class="number">34</span>, salary=<span class="number">6504</span>, gender=<span class="string">&#x27;男&#x27;</span>, area=<span class="string">&#x27;广州&#x27;</span>&#125;, Persion&#123;name=<span class="string">&#x27;李四&#x27;</span>, age=<span class="number">23</span>, salary=<span class="number">7600</span>, gender=<span class="string">&#x27;女&#x27;</span>, area=<span class="string">&#x27;天津&#x27;</span>&#125;, Persion&#123;name=<span class="string">&#x27;张三&#x27;</span>, age=<span class="number">26</span>, salary=<span class="number">8000</span>, gender=<span class="string">&#x27;男&#x27;</span>, area=<span class="string">&#x27;广州&#x27;</span>&#125;, Persion&#123;name=<span class="string">&#x27;赵六&#x27;</span>, age=<span class="number">40</span>, salary=<span class="number">8000</span>, gender=<span class="string">&#x27;女&#x27;</span>, area=<span class="string">&#x27;上海&#x27;</span>&#125;, Persion&#123;name=<span class="string">&#x27;王五&#x27;</span>, age=<span class="number">43</span>, salary=<span class="number">8409</span>, gender=<span class="string">&#x27;男&#x27;</span>, area=<span class="string">&#x27;北京&#x27;</span>&#125;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="3-8提取-组合"><a href="#3-8提取-组合" class="headerlink" title="3.8提取/组合"></a>3.8提取/组合</h3><p>流也可以进行合并,去重,限制,跳过等操作</p>
<p><img src="https://img-blog.csdnimg.cn/20201109150012790.jpg" alt="在这里插入图片描述"></p>
<p><img src="https://img-blog.csdnimg.cn/20201109150001270.jpg" alt="在这里插入图片描述"></p>
<p><img src="https://img-blog.csdnimg.cn/20201109145946301.jpg" alt="在这里插入图片描述"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> String[] str1 = &#123;<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;D&quot;</span>&#125;;</span><br><span class="line"> String[] str2 = &#123;<span class="string">&quot;C&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;E&quot;</span>, <span class="string">&quot;F&quot;</span>&#125;;</span><br><span class="line"> Stream&lt;String&gt; stream1 = Stream.of(str1);</span><br><span class="line"> Stream&lt;String&gt; stream2 = Stream.of(str2);</span><br><span class="line">  <span class="comment">//合并流</span></span><br><span class="line"> List&lt;String&gt; collect1 = Stream.concat(stream1, stream2).collect(Collectors.toList());</span><br><span class="line"> System.out.println(collect1);</span><br><span class="line"><span class="comment">//[A, B, C, D, C, D, E, F]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//去重</span></span><br><span class="line">List&lt;String&gt; collect2 = Stream.concat(stream1, stream2).distinct().collect(Collectors.toList());</span><br><span class="line">System.out.println(collect2);</span><br><span class="line"><span class="comment">//[A, B, C, D, E, F]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//限制流</span></span><br><span class="line">List&lt;Integer&gt; collect1 = Stream.iterate(<span class="number">1</span>, x -&gt; x + <span class="number">3</span>).limit(<span class="number">3</span>).collect(Collectors.toList());</span><br><span class="line">System.out.println(collect1);</span><br><span class="line"><span class="comment">//[1, 4, 7]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//跳过前n个数据</span></span><br><span class="line">List&lt;Integer&gt; collect3 = Stream.iterate(<span class="number">1</span>, x -&gt; x + <span class="number">3</span>).skip(<span class="number">3</span>).limit(<span class="number">10</span>).collect(Collectors.toList());</span><br><span class="line">System.out.println(collect3);</span><br><span class="line"><span class="comment">//[10, 13, 16, 19, 22, 25, 28, 31, 34, 37]</span></span><br></pre></td></tr></table></figure>



<h2 id="4-Stream源码解读"><a href="#4-Stream源码解读" class="headerlink" title="4.Stream源码解读"></a>4.Stream源码解读</h2><p><strong>想要了解源码,首先要了解这些类是什么</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">BiConsumer.java</span><br><span class="line">BiFunction.java</span><br><span class="line">BinaryOperator.java</span><br><span class="line">BiPredicate.java</span><br><span class="line">BooleanSupplier.java</span><br><span class="line">Consumer.java</span><br><span class="line">DoubleBinaryOperator.java</span><br><span class="line">DoubleConsumer.java</span><br><span class="line">DoubleFunction.java</span><br><span class="line">DoublePredicate.java</span><br><span class="line">DoubleSupplier.java</span><br><span class="line">DoubleToIntFunction.java</span><br><span class="line">DoubleToLongFunction.java</span><br><span class="line">DoubleUnaryOperator.java</span><br><span class="line">Function.java</span><br><span class="line">IntBinaryOperator.java</span><br><span class="line">IntConsumer.java</span><br><span class="line">IntFunction.java</span><br><span class="line">IntPredicate.java</span><br><span class="line">IntSupplier.java</span><br><span class="line">IntToDoubleFunction.java</span><br><span class="line">IntToLongFunction.java</span><br><span class="line">IntUnaryOperator.java</span><br><span class="line">LongBinaryOperator.java</span><br><span class="line">LongConsumer.java</span><br><span class="line">LongFunction.java</span><br><span class="line">LongPredicate.java</span><br><span class="line">LongSupplier.java</span><br><span class="line">LongToDoubleFunction.java</span><br><span class="line">LongToIntFunction.java</span><br><span class="line">LongUnaryOperator.java</span><br><span class="line">ObjDoubleConsumer.java</span><br><span class="line">ObjIntConsumer.java</span><br><span class="line">ObjLongConsumer.java</span><br><span class="line"><span class="keyword">package</span>-info.java</span><br><span class="line">Predicate.java</span><br><span class="line">Supplier.java</span><br><span class="line">ToDoubleBiFunction.java</span><br><span class="line">ToDoubleFunction.java</span><br><span class="line">ToIntBiFunction.java</span><br><span class="line">ToIntFunction.java</span><br><span class="line">ToLongBiFunction.java</span><br><span class="line">ToLongFunction.java</span><br><span class="line">UnaryOperator.java</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/12/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="冯玮">
      <meta itemprop="description" content="以梦为马，明日天涯">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冯玮的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/12/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">设计模式-装饰器模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-12 15:31:47 / 修改时间：15:32:45" itemprop="dateCreated datePublished" datetime="2020-11-12T15:31:47+08:00">2020-11-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="装饰器模式"><a href="#装饰器模式" class="headerlink" title="装饰器模式"></a>装饰器模式</h1><h2 id="一、装饰器模式介紹"><a href="#一、装饰器模式介紹" class="headerlink" title="一、装饰器模式介紹"></a>一、装饰器模式介紹</h2><p>装饰器模式的核心是在不改原有类的基础上给类新增功能，不改变原有类，可能有的小伙伴就会想到继承、AOP切面，当然这些方式都可以实现，但是使用装饰器模式会是另一种思路更为灵活，可以避免继承导致子类过多。也可以避免AOP带来的复杂性；</p>
<p>很多熟悉的场景用到装饰器模式：</p>
<p><code>new BuffereReader(new FileReader(&quot;&quot;));</code>这段代码你是否熟悉。相信学习java到字节流，字符流。文件流的内容时都见到了这样的代码，一层嵌套一层，一层嵌套一层，字节流转字符流等等，而这样的方式使用就是装饰器的一种体现</p>
<h2 id="二、案例场景模拟"><a href="#二、案例场景模拟" class="headerlink" title="二、案例场景模拟"></a>二、案例场景模拟</h2><p><img src="https://bugstack.cn/assets/images/2020/itstack-demo-design-9-02.png" alt="场景模拟；单点登录功能扩展"></p>
<p><strong>在本案例中我们模拟一个单点登录功能扩充的场景</strong></p>
<p>谁也业务的逐渐发展，从刚开始的内部ERP系统仅仅需要判断用户验证即可，验证成功以后，访问所有的资源，业务的扩展之后，团队里面出现专门的运营人员，营销人员，数据藤原，每个人的对与ERP的使用需求不同，并且为了保证数据的安全性，不会让每个用户都有最高的权限</p>
<p>那么以往使用<code>sso</code>是一个组件化通用的服务，不能在里面添加需要的用户访问验证功能，这个时候我们就可以使用装饰器模式，扩展原有的单点登录系统，但同时也要保证原有功能不够影响，可以继续使用</p>
<h3 id="1-案例模拟工程"><a href="#1-案例模拟工程" class="headerlink" title="1.案例模拟工程"></a>1.案例模拟工程</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">itstack-demo-design-9-00</span><br><span class="line">└── src</span><br><span class="line">    └── main</span><br><span class="line">        └── java</span><br><span class="line">            └── org.itstack.demo.design</span><br><span class="line">                ├── HandlerInterceptor.java</span><br><span class="line">                └── SsoInterceptor.java</span><br></pre></td></tr></table></figure>

<ul>
<li>这里模拟的是spring中的类：<code>HandlerInterceptor</code>，实现接口功能<code>SsoInterceptor</code>模拟的单点登录拦截服务。</li>
<li>为了避免引入太多spring的内容影响对设计模式的阅读，这里使用了同名的类和方法，尽可能减少外部的依赖</li>
</ul>
<p>模拟<code>spring</code>的<code>HanlderInterceptor</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandleInterceptor</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(String request,String response,Object handler)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际的单点登录开发会基于<code>org.springframework.web.servlet.HandlerInterceptor</code>  来实现</p>
<p>模拟单点登录操作功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SsoInterceptor</span> <span class="keyword">implements</span>  <span class="title">HandleInterceptor</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandel</span><span class="params">(String request,String response,Object handler)</span></span>&#123;</span><br><span class="line">        <span class="comment">//模拟获取cookie</span></span><br><span class="line">        String ticket = request.substring(<span class="number">1</span>,<span class="number">8</span>);</span><br><span class="line">        <span class="comment">//模拟校验</span></span><br><span class="line">        <span class="keyword">return</span> ticket.equals(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里的模拟实现非常的简单只是截取字符串。实际使用需要从<code>HttpServletRequest request</code>对象中获取<code>cookie</code>信息，解析<code>ticket</code>值做校验。</li>
<li>在返回的里面而非常的简单，只要获取到了success就认为允许登录</li>
</ul>
<h2 id="三、装饰器模式重构代码"><a href="#三、装饰器模式重构代码" class="headerlink" title="三、装饰器模式重构代码"></a>三、装饰器模式重构代码</h2><p>装饰器模式主要解决的是直接继承下因功能的不断横向扩展导致子类膨胀的问题,而是用装饰器模式后就会比直接继承显得更加灵活,同事这样也就不再需要子类的维护</p>
<p>在装饰器模式中有四个比较重要的角色:</p>
<ol>
<li>抽象构建角色 – 定义抽象接口</li>
<li>具体构建角色 – 实现抽象接口,可以是一组</li>
<li>装饰角色 – 定义抽象类并继承接口中的方法,保证一致性</li>
<li>具体装饰角色 – 扩展装饰具体的实现逻辑</li>
</ol>
<p>通过以上这四项来实现装饰器模式,主要核心内容会体现在抽象类的定义和实现上.</p>
<p>工程结构</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">├─src</span><br><span class="line">│  ├─main</span><br><span class="line">│  │  └─java</span><br><span class="line">│  │      └─org</span><br><span class="line">│  │          └─itstack</span><br><span class="line">│  │              └─demo</span><br><span class="line">│  │                  └─design</span><br><span class="line">│  │                          HandlerInterceptor.java</span><br><span class="line">│  │                          SsoInterceptor.java</span><br></pre></td></tr></table></figure>

<p><img src="https://bugstack.cn/assets/images/2020/itstack-demo-design-9-03.png" alt="装饰器模式模型结构"></p>
<ul>
<li>以上是一个装饰器实现的类图结构,重点的类是<code>SsoDecorator</code> ,这个类是一个抽象类,主要完成了对接口<code>handlerIntercrptor</code>  继承</li>
<li>当装饰角色继承接口后会提供构造函数,入参就是继承的接口实现类即可,这样就可以很方便的扩展出不同功能的组件</li>
</ul>
<p><strong>代码实现</strong></p>
<p>抽象类装饰角色</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">SsoDecorator</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> HandleInterceptor handleInterceptor;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SsoDecorator</span> <span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SsoDecorator</span><span class="params">(HandleInterceptor handleInterceptor)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.handleInterceptor = handleInterceptor;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(String request,String response,Object handler)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> handleInterceptor.preHandle(requrst,response,handler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在 装饰类中有两个重点的地方是: 1&gt;继承了处理接口 2&gt;提供了构造函数 3&gt;覆盖了方法 <code>preHandle</code></li>
<li>以上三个点是装饰器模式的核心处理部分,这样可以踢掉对子类继承的方式时间逻辑功能扩展</li>
</ul>
<p>装饰角色逻辑实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginSsoDecorator</span> <span class="keyword">extends</span> <span class="title">SsoDecorator</span></span>&#123;</span><br><span class="line">     <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(LoginSsoDecorator.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, String&gt; authMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        authMap.put(<span class="string">&quot;huahua&quot;</span>, <span class="string">&quot;queryUserInfo&quot;</span>);</span><br><span class="line">        authMap.put(<span class="string">&quot;doudou&quot;</span>, <span class="string">&quot;queryUserInfo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginSsoDecorator</span><span class="params">(HandlerInterceptor handlerInterceptor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(handlerInterceptor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(String request, String response, Object handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> success = <span class="keyword">super</span>.preHandle(request, response, handler);</span><br><span class="line">        <span class="keyword">if</span> (!success) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        String userId = request.substring(<span class="number">8</span>);</span><br><span class="line">        String method = authMap.get(userId);</span><br><span class="line">        logger.info(<span class="string">&quot;模拟单点登录方法访问拦截校验：&#123;&#125; &#123;&#125;&quot;</span>, userId, method);</span><br><span class="line">        <span class="comment">// 模拟方法校验</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;queryUserInfo&quot;</span>.equals(method);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在具体的装饰类实现中,继承了装饰类<code>SsoDecorator</code> 那么现在就可以扩展方法,<code>preHandle</code></li>
<li>在<code>preHandel</code>的实现中可以看到,这里只关心扩展的部分功能,同时不会影响原有类的核心服务,也不会因为使用继承方式而导致的多余子类,增加了整体的灵活性</li>
</ul>
<h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><ul>
<li>使用装饰器模式满足单元职责原则,你可以在自己的装饰类中完成功能逻辑的扩展,而不影响主类,同时可以按需在运行时添加和删除这部分逻辑,另外装饰器模式与继承弗雷重写方法,在某些时候需要按需选择,并不一定某一个就是最好</li>
<li>装饰器实现的重点是对抽象类继承接口方式的使用,同时设定被集成的接口可以通过构造函数传递其实现类,由此增加扩展性并重写方法里可以实现此部分父类实现的功能</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/11/%E9%98%BF%E9%87%8Cdruid%E6%95%B0%E6%8D%AE%E6%BA%90%E9%85%8D%E7%BD%AE%E5%8F%8A%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="冯玮">
      <meta itemprop="description" content="以梦为马，明日天涯">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冯玮的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/11/%E9%98%BF%E9%87%8Cdruid%E6%95%B0%E6%8D%AE%E6%BA%90%E9%85%8D%E7%BD%AE%E5%8F%8A%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86/" class="post-title-link" itemprop="url">阿里druid数据源配置及数据库密码加密</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-11 22:30:04 / 修改时间：22:30:32" itemprop="dateCreated datePublished" datetime="2020-11-11T22:30:04+08:00">2020-11-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="阿里druid数据源配置及数据库密码加密"><a href="#阿里druid数据源配置及数据库密码加密" class="headerlink" title="阿里druid数据源配置及数据库密码加密"></a>阿里druid数据源配置及数据库密码加密</h1><p>注意:</p>
<ul>
<li>阿里默认只对用户密码解密</li>
<li>druid 1.0.16版本及以上的解密时同时配置publicKey</li>
</ul>
<h2 id="生成密文密码"><a href="#生成密文密码" class="headerlink" title="生成密文密码"></a>生成密文密码</h2><ol>
<li><p>前提是已经配置了JDK环境,生成密文密码需要准备druid的jar包,然后通过命令行生成.如下步骤:</p>
<p>准备jar包,执行命令行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp druid-1.1.21.jar com.alibaba.druid.filter.config.ConfigTools yourpassword</span><br></pre></td></tr></table></figure>

<p>注意:druid1.0.16之前</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java <span class="literal">-cp</span> druid<span class="literal">-0</span>.<span class="number">2.23</span>.jar com.alibaba.druid.filter.config.ConfigTools yourpassword  </span><br></pre></td></tr></table></figure>



</li>
</ol>
<p><img src="https://img2018.cnblogs.com/blog/1179838/201907/1179838-20190710105734396-200140930.png" alt="img"></p>
<p>注意在druid 1.0.16及以后</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp druid-1.1.9.jar com.alibaba.druid.filter.config.ConfigTools 123456pwd &gt;aaa.txt </span><br></pre></td></tr></table></figure>

<p><img src="https://img2018.cnblogs.com/blog/1179838/201907/1179838-20190710105757521-1711488764.png" alt="img"></p>
<h2 id="dataSource配置"><a href="#dataSource配置" class="headerlink" title="dataSource配置"></a>dataSource配置</h2><p>jdbc.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## JDBC set</span></span><br><span class="line"><span class="meta">jdbc.url</span>=<span class="string">jdbc\:mysql\://localhost\:3306/edu_demo?useUnicode\=true&amp;characterEncoding\=utf-8</span></span><br><span class="line"><span class="meta">jdbc.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">jdbc.password</span>=<span class="string">Obsbr4gd1oVyYr+k4KQdUMNYgKMWdDibsNJTabnph+yPmxjc6tUrT1GNsPDqa9ZvTF9QvaRD86H+Zn/H+yz2jA\=\=</span></span><br></pre></td></tr></table></figure>

<p>dataSource配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 基于Druid数据库链接池的数据源配置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 基本属性driverClassName、 url、user、password --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置初始化大小、最小、最大 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 通常来说，只需要修改initialSize、minIdle、maxActive --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;initialSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;minIdle&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxActive&quot;</span> <span class="attr">value</span>=<span class="string">&quot;30&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testWhileIdle&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置获取连接等待超时的时间 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxWait&quot;</span> <span class="attr">value</span>=<span class="string">&quot;5000&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置一个连接在池中最小生存的时间，单位是毫秒 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;minEvictableIdleTimeMillis&quot;</span> <span class="attr">value</span>=<span class="string">&quot;30000&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;timeBetweenEvictionRunsMillis&quot;</span> <span class="attr">value</span>=<span class="string">&quot;60000&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 解密密码必须要配置的项 *************************************  这里是重点--&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;filters&quot;</span> <span class="attr">value</span>=<span class="string">&quot;config&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connectionProperties&quot;</span> <span class="attr">value</span>=<span class="string">&quot;config.decrypt=true&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意: druid及以后</p>
<p>jdbc.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## JDBC set</span></span><br><span class="line"><span class="meta">jdbc.url</span>=<span class="string">jdbc\:mysql\://localhost\:3306/edu_demo?useUnicode\=true&amp;characterEncoding\=utf-8</span></span><br><span class="line"><span class="meta">jdbc.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">jdbc.password</span>=<span class="string">Obsbr4gd1oVyYr+k4KQdUMNYgKMWdDibsNJTabnph+yPmxjc6tUrT1GNsPDqa9ZvTF9QvaRD86H+Zn/H+yz2jA\=\=</span></span><br><span class="line"><span class="meta">jdbc.publickey</span> = <span class="string">MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAKHGwq7q2RmwuRgKxBypQHw0mYu4BQZ3eMsTrdK8E6igRcxsobUC7uT0SoxIjl1WveWniCASejoQtn/BY6hVKWsCAwEAAQ==</span></span><br></pre></td></tr></table></figure>

<p>dataSource配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 基于Druid数据库链接池的数据源配置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 基本属性driverClassName、 url、user、password --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 解密密码必须要配置的项 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;filters&quot;</span> <span class="attr">value</span>=<span class="string">&quot;config&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connectionProperties&quot;</span> <span class="attr">value</span>=<span class="string">&quot;config.decrypt=true;config.decrypt.key=$&#123;jdbc.publickey&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置初始化大小、最小、最大 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 通常来说，只需要修改initialSize、minIdle、maxActive --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;initialSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;minIdle&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxActive&quot;</span> <span class="attr">value</span>=<span class="string">&quot;30&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testWhileIdle&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置获取连接等待超时的时间 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxWait&quot;</span> <span class="attr">value</span>=<span class="string">&quot;5000&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置一个连接在池中最小生存的时间，单位是毫秒 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;minEvictableIdleTimeMillis&quot;</span> <span class="attr">value</span>=<span class="string">&quot;30000&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;timeBetweenEvictionRunsMillis&quot;</span> <span class="attr">value</span>=<span class="string">&quot;60000&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上就是druid提供的明文加密的配置方案.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="冯玮">
      <meta itemprop="description" content="以梦为马，明日天涯">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冯玮的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">设计模式-适配器模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-06 08:44:32 / 修改时间：08:45:04" itemprop="dateCreated datePublished" datetime="2020-11-06T08:44:32+08:00">2020-11-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="适配器模式"><a href="#适配器模式" class="headerlink" title="适配器模式"></a>适配器模式</h1><h2 id="案例场景"><a href="#案例场景" class="headerlink" title="案例场景"></a>案例场景</h2><p> 随着公司业务的不断发展,当基础的系统逐步成型以后,业务运营就需要开始做用户的拉新和促活.从而保障<code>DUA</code>的增速以及最终<code>ROI</code>转换</p>
<p>而这时候就会需要做一些营销系统,大部分常见的都是裂变.拉客,例如:你邀请一个用户开户,或者邀请一个用户下单,那么平台就会给你返利,多邀多得,同事随着拉新的 量越来越多开始设置每月下单都会给首单奖励等等买各种营销场景</p>
<p>那么这个时候会做一个系统就会接收各种各样的MQ消息或者接口,如果一个个的去开发,就会耗费很大的成本,同事对于后期的拓展也有一定的难度,此时就会希望有一个系统可以配置一下就把外部的MQ接入进行,这些MQ就像上面提到的可能是 一些注册开户信息,商品下单消息等等</p>
<p>而适配器的思想方式也恰恰可以御用到这里,并且我想强调 一下,适配器不只是可以适配接口往往还可以适配一些属性信息.</p>
<p>1.场景模拟工程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">itstack-demo-design-6-00</span><br><span class="line">└── src</span><br><span class="line">    └── main</span><br><span class="line">        └── java</span><br><span class="line">            └── org.itstack.demo.design</span><br><span class="line">                ├── mq</span><br><span class="line">                │   ├── create_account.java</span><br><span class="line">                │   ├── OrderMq.java</span><br><span class="line">                │   └── POPOrderDelivered.java</span><br><span class="line">                └── service</span><br><span class="line">                    ├── OrderServicejava</span><br><span class="line">                    └── POPOrderService.java</span><br></pre></td></tr></table></figure>

<ul>
<li>这里模拟了三个不同类型的MQ消息,而在消息体中都有一些必要的字段,比如用户ID,时间,业务id.但每个MQ消息的字段属性并不一样.就像用户id在不同的MQ里也有不同的字段:uid,userid等</li>
<li>同时还提供了两个不同类型的接口,一个用于查询内部订单下单数量,一个 用于第三方是否首单</li>
<li>后面会把这些不同类型的MQ和接口做适配兼容</li>
</ul>
<p>2.场景简述</p>
<p>注册开户MQ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">create_account</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String number;      <span class="comment">// 开户编号</span></span><br><span class="line">    <span class="keyword">private</span> String address;     <span class="comment">// 开户地</span></span><br><span class="line">    <span class="keyword">private</span> Date accountDate;   <span class="comment">// 开户时间</span></span><br><span class="line">    <span class="keyword">private</span> String desc;        <span class="comment">// 开户描述</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... get/set     </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>内部订单MQ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderMq</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String uid;           <span class="comment">// 用户ID</span></span><br><span class="line">    <span class="keyword">private</span> String sku;           <span class="comment">// 商品</span></span><br><span class="line">    <span class="keyword">private</span> String orderId;       <span class="comment">// 订单ID</span></span><br><span class="line">    <span class="keyword">private</span> Date createOrderTime; <span class="comment">// 下单时间     </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... get/set      </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第三方订单MQ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">POPOrderDelivered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String uId;     <span class="comment">// 用户ID</span></span><br><span class="line">    <span class="keyword">private</span> String orderId; <span class="comment">// 订单号</span></span><br><span class="line">    <span class="keyword">private</span> Date orderTime; <span class="comment">// 下单时间</span></span><br><span class="line">    <span class="keyword">private</span> Date sku;       <span class="comment">// 商品</span></span><br><span class="line">    <span class="keyword">private</span> Date skuName;   <span class="comment">// 商品名称</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal decimal; <span class="comment">// 金额</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... get/set      </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询用户内部下单数量接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(POPOrderService.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">queryUserOrderCount</span><span class="params">(String userId)</span></span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;自营商家，查询用户的订单是否为首单：&#123;&#125;&quot;</span>, userId);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询用户第三方下单首单接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">POPOrderService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(POPOrderService.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFirstOrder</span><span class="params">(String uId)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;POP商家，查询用户的订单是否为首单：&#123;&#125;&quot;</span>, uId);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以上这几项就是不同MQ以及不同的 接口的一个体现,后面我们将使用这样的MQ消息和接口给他们做相应的适配</li>
</ul>
<h2 id="适配器模式构造代码"><a href="#适配器模式构造代码" class="headerlink" title="适配器模式构造代码"></a>适配器模式构造代码</h2><p> 统一的MQ消息体适配器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RebateInfo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String userId;  <span class="comment">// 用户ID</span></span><br><span class="line">    <span class="keyword">private</span> String bizId;   <span class="comment">// 业务ID</span></span><br><span class="line">    <span class="keyword">private</span> Date bizTime;   <span class="comment">// 业务时间</span></span><br><span class="line">    <span class="keyword">private</span> String desc;    <span class="comment">// 业务描述</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... get/set</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>MQ消息中会有多种多样的类型属性,虽然他们都有同样的值提供给适用方,但是如果都这样接入那么当MQ消息特别多的时候就会很麻烦</li>
<li>所以在这个 案例中,我们定义了通用的MQ消息体,后续把所有接入进来的消息进行统一的处理</li>
</ul>
<p>MQ消息体适配器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RebateInfo <span class="title">filter</span><span class="params">(String strJson, Map&lt;String, String&gt; link)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> filter(JSON.parseObject(strJson, Map.class), link);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RebateInfo <span class="title">filter</span><span class="params">(Map obj, Map&lt;String, String&gt; link)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException </span>&#123;</span><br><span class="line">        RebateInfo rebateInfo = <span class="keyword">new</span> RebateInfo();</span><br><span class="line">        <span class="keyword">for</span> (String key : link.keySet()) &#123;</span><br><span class="line">            Object val = obj.get(link.get(key));</span><br><span class="line">            RebateInfo.class.getMethod(<span class="string">&quot;set&quot;</span> + key.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase() + key.substring(<span class="number">1</span>), String.class).invoke(rebateInfo, val.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rebateInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>这个类中的方法非常的重要,主要 用于把不同类型的MQ的各种属性映射成我们需要的属性并返回,.就像用户id.uid ,映射成我们需要的userid 做统一处理</p>
</li>
<li><p>而在这个处理过程中需要把映射管理传递给<code>Map&lt;String,String&gt; link</code>,就是准确的描述了,当前MQ中某个属性的名称,映射为我们的某个属性名称</p>
</li>
<li><p>最终因为我们接受到的mq消息基本都是json格式,可以转换为map格式,最后使用反射调用的方式给我们的类型赋值</p>
<p>测试适配类</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_MQAdapter</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchMethodException, IllegalAccessException, InvocationTargetException </span>&#123;</span><br><span class="line">    create_account create_account = <span class="keyword">new</span> create_account();</span><br><span class="line">    create_account.setNumber(<span class="string">&quot;100001&quot;</span>);</span><br><span class="line">    create_account.setAddress(<span class="string">&quot;河北省.廊坊市.广阳区.大学里职业技术学院&quot;</span>);</span><br><span class="line">    create_account.setAccountDate(<span class="keyword">new</span> Date());</span><br><span class="line">    create_account.setDesc(<span class="string">&quot;在校开户&quot;</span>);          </span><br><span class="line"></span><br><span class="line">    HashMap&lt;String, String&gt; link01 = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">    link01.put(<span class="string">&quot;userId&quot;</span>, <span class="string">&quot;number&quot;</span>);</span><br><span class="line">    link01.put(<span class="string">&quot;bizId&quot;</span>, <span class="string">&quot;number&quot;</span>);</span><br><span class="line">    link01.put(<span class="string">&quot;bizTime&quot;</span>, <span class="string">&quot;accountDate&quot;</span>);</span><br><span class="line">    link01.put(<span class="string">&quot;desc&quot;</span>, <span class="string">&quot;desc&quot;</span>);</span><br><span class="line">    RebateInfo rebateInfo01 = MQAdapter.filter(create_account.toString(), link01);</span><br><span class="line">    System.out.println(<span class="string">&quot;mq.create_account(适配前)&quot;</span> + create_account.toString());</span><br><span class="line">    System.out.println(<span class="string">&quot;mq.create_account(适配后)&quot;</span> + JSON.toJSONString(rebateInfo01));</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    OrderMq orderMq = <span class="keyword">new</span> OrderMq();</span><br><span class="line">    orderMq.setUid(<span class="string">&quot;100001&quot;</span>);</span><br><span class="line">    orderMq.setSku(<span class="string">&quot;10928092093111123&quot;</span>);</span><br><span class="line">    orderMq.setOrderId(<span class="string">&quot;100000890193847111&quot;</span>);</span><br><span class="line">    orderMq.setCreateOrderTime(<span class="keyword">new</span> Date()); </span><br><span class="line"></span><br><span class="line">    HashMap&lt;String, String&gt; link02 = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">    link02.put(<span class="string">&quot;userId&quot;</span>, <span class="string">&quot;uid&quot;</span>);</span><br><span class="line">    link02.put(<span class="string">&quot;bizId&quot;</span>, <span class="string">&quot;orderId&quot;</span>);</span><br><span class="line">    link02.put(<span class="string">&quot;bizTime&quot;</span>, <span class="string">&quot;createOrderTime&quot;</span>);</span><br><span class="line">    RebateInfo rebateInfo02 = MQAdapter.filter(orderMq.toString(), link02);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;mq.orderMq(适配前)&quot;</span> + orderMq.toString());</span><br><span class="line">    System.out.println(<span class="string">&quot;mq.orderMq(适配后)&quot;</span> + JSON.toJSONString(rebateInfo02));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在这里我们分别模拟传入了两个不同的MQ消息，并设置字段的映射关系。</li>
<li>等真的业务场景开发中，就可以配这种映射配置关系交给配置文件或者数据库后台配置，减少编码。</li>
</ul>
<p>测试结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mq.create_account(适配前)&#123;<span class="string">&quot;accountDate&quot;</span>:<span class="number">1591024816000</span>,<span class="string">&quot;address&quot;</span>:<span class="string">&quot;河北省.廊坊市.广阳区.大学里职业技术学院&quot;</span>,<span class="string">&quot;desc&quot;</span>:<span class="string">&quot;在校开户&quot;</span>,<span class="string">&quot;number&quot;</span>:<span class="string">&quot;100001&quot;</span>&#125;</span><br><span class="line">mq.create_account(适配后)&#123;<span class="string">&quot;bizId&quot;</span>:<span class="string">&quot;100001&quot;</span>,<span class="string">&quot;bizTime&quot;</span>:<span class="number">1591077840669</span>,<span class="string">&quot;desc&quot;</span>:<span class="string">&quot;在校开户&quot;</span>,<span class="string">&quot;userId&quot;</span>:<span class="string">&quot;100001&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">mq.orderMq(适配前)&#123;<span class="string">&quot;createOrderTime&quot;</span>:<span class="number">1591024816000</span>,<span class="string">&quot;orderId&quot;</span>:<span class="string">&quot;100000890193847111&quot;</span>,<span class="string">&quot;sku&quot;</span>:<span class="string">&quot;10928092093111123&quot;</span>,<span class="string">&quot;uid&quot;</span>:<span class="string">&quot;100001&quot;</span>&#125;</span><br><span class="line">mq.orderMq(适配后)&#123;<span class="string">&quot;bizId&quot;</span>:<span class="string">&quot;100000890193847111&quot;</span>,<span class="string">&quot;bizTime&quot;</span>:<span class="number">1591077840669</span>,<span class="string">&quot;userId&quot;</span>:<span class="string">&quot;100001&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<ul>
<li>从上面可以看到，同样的字段值在做了适配前后分别有统一的字段属性，进行处理。这样业务开发中也就非常简单了。</li>
<li>另外有一个非常重要的地方，在实际业务开发中，除了反射的使用外，还可以加入<strong>代理类</strong>把映射的配置交给它。这样就可以不需要每一个mq都手动创建类了。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">冯玮</p>
  <div class="site-description" itemprop="description">以梦为马，明日天涯</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">冯玮</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
